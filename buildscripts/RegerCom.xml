
<project name="RegerCom" default="QuickBuild" basedir=".">
  <description>
        The Best Darn Build Process This Side of Sanity
  </description>

  <!-- Import properties file -->
  <property file="Regercom.properties"/>


  <!-- Create a buildnumber -->
  <target name="buildnumber" description="Create a build number.">
     <echo message="Generating build number."/>
     <buildnumber/>
  </target>

  <!-- Create a timestamp -->
  <target name="timestamp" description="Create the dirs" depends="buildnumber">
  	 <echo message="Generating timestamp."/>
     <tstamp>
        <format property="build.time" pattern="yyyy-MM-dd-(hh-mm-ssaa)"/>
     </tstamp>
  </target>

  <!-- Import build number file -->
  <property file="build.number"/>

  <!-- Set internal script properties -->
  <property name="tomcat.app.name" value="RegerCom"/>
  <property name="builddir" value="${builds.directory}"/>
  <property name="lastbuild" value="${builddir}/lastbuild/${tomcat.app.name}"/>
  <property name="wardir" value="${builddir}/WARs/${tomcat.app.name}"/>
  <property name="javasrc" value="${builddir}/lastbuild/${tomcat.app.name}/WEB-INF/classes"/>
  <property name="sourcedir" value="${source.root.directory}"/>


  <!-- If the build process fails saying that a context doesn't exist, just go into the web-based tomcat manager and create an app named ${tomcat.app.name}... for the script to be able to remove an app it needs to be there in the first place.  Probably a better workaround in Ant, but I haven't researched it yet. Yes, this solution sucks.  Joe -->


  <!-- First, Delete any files in the lastbuild folder -->
  <target name="cleanuplastbuild" description="Cleans up the last build" depends="timestamp">
    <delete dir="${lastbuild}"/>
  </target>

  <!-- This target takes all files required for the build and puts them into lastbuild which is basically a temp building location -->
  <!-- This is done so that I can have Vars.java and VarsDev.java, choosing which one to put into the build at buildtime -->
  <target name="movefilestolastbuild" description="Moves files to the lastbuild directory." depends="cleanuplastbuild">
      <copy todir="${lastbuild}">
        <fileset dir="${sourcedir}" excludes="**.*Thumbs.db"/>
      </copy>
  </target>




  <!-- Compile the app-->
   <target name="compile" description="compile the source" depends="movefilestolastbuild">
  	 <echo message="Compiling Java code."/>
       <javac srcdir="${javasrc}" excludes="**.x" debug="on" classpath="${javaclasspath}"/>
   </target>
   
   <!-- Create reger.jar package -->
   <target name="createregerjar" description="Creates the re-usable regercore.jar package" depends="compile">
        <echo message="Creating regercore.jar."/>
        <jar jarfile="${builddir}/regercore.jar">
            <fileset dir="${javasrc}">
                <include name="reger/core/**"/>
                <exclude name="**/*.java"/>
            </fileset>
        </jar>
   </target>


   
   <!-- Package the app -->
   <target name="package" description="Create the WAR file" depends="compile">
        <echo message="Packaging ${tomcat.app.name}'s war file."/>
        <delete>
            <fileset dir="." includes="*.war"/>
        </delete>
        <war destfile="${tomcat.app.name}-(bld${build.number})-${build.time}.war" webxml="${lastbuild}/WEB-INF/web.xml">
            <fileset dir="${lastbuild}">
                <exclude name="**/*.java"/>
                <exclude name="**/web.xml"/>
            </fileset>
        </war>
		<copy file="${tomcat.app.name}-(bld${build.number})-${build.time}.war" todir="${builddir}"/>
   </target>

   <target name="packagewithsource" description="Backup source files" depends="package">
        <echo message="Backing up ${tomcat.app.name}'s source."/>
        <jar jarfile="${builddir}/${tomcat.app.name}-(bld${build.number})-${build.time}-src.jar">
            <fileset dir="./">
                <exclude name="builds/**"/>
            </fileset>
        </jar>
   </target>

   
    <!-- Tomcat Deployers -->
    <target name="undeploy" description="Undeploys the Web Application" depends="packagewithsource">
        <ant antfile="TomcatDeploy.xml" target="undeployApp" inheritAll="true"/> 
    </target>
    <target name="deploy" description="Deploys the Web Application" depends="undeploy">
    	  <ant antfile="TomcatDeploy.xml" target="deployApp" inheritAll="true"/> 
    </target>
    <target name="deployNew" description="Deploys the Web Application" depends="packagewithsource">
        <ant antfile="TomcatDeploy.xml" target="deployNewApp" inheritAll="true"/> 
    </target>

    
    <!-- Dev WAR file builders -->
    <!-- Use to build WAR file to manually deploy. -->
    <!-- It will be called ROOT.war and will be found in the root build directory -->
    <target name="buildWar" description="Builds a war file and does not deploy it." depends="packagewithsource">
        <echo message="Creating ROOT.war for ${tomcat.app.name}."/>
        <copy file="${tomcat.app.name}-(bld${build.number})-${build.time}.war" tofile="${wardir}/ROOT.war" overwrite="true"/>
		<delete file="${tomcat.app.name}-(bld${build.number})-${build.time}.war"/>
    </target>

    <!-- Obfuscate with yGuard -->
    <target name="buildObfuscated" description="Builds an obfuscated jar." depends="compile">
        <jar destfile="${lastbuild}/WEB-INF/lib/reger.jar" basedir="${javasrc}" excludes="**/*.java" />
        <!-- I should now delete the classes -->
        <taskdef name="obfuscate" classname="com.yworks.yguard.ObfuscatorTask" classpath="source/WEB-INF/lib/yguard.jar"/>
        <obfuscate mainclass="reger.core" logfile="obfuscationlog.xml">
            <inoutpair in="${lastbuild}/WEB-INF/lib/reger.jar" out="${lastbuild}/WEB-INF/lib/regerObfuscated.jar"/>
            <expose>
                <class classes="public" methods="public" fields="public">
                    <patternset>
                        <include name="**.*"/>
                    </patternset>
                </class>
            </expose>
        </obfuscate>
    </target>



    <!-- Create javaDoc -->
    <target name="createJavaDoc" description="Creates javadoc" depends="">
        <echo message="Creating javaDoc for ${tomcat.app.name}."/>
        <delete dir="${builddir}/javaDoc"/>

        <javadoc destdir="${builddir}/javaDoc" author="true" version="true" use="true" windowtitle="Reger.com javaDoc">

            <packageset dir="${sourcedir}/WEB-INF/classes" defaultexcludes="yes">
                <include name="reger/**" />
            </packageset>

            <doctitle><![CDATA[<h1>Reger.com</h1>]]></doctitle>
            <bottom><![CDATA[<i>Copyright &#169; 2005 Reger.com. Confidential and proprietary. All Rights Reserved.</i>]]></bottom>

        </javadoc>

    </target>
	
    
    <target name="QuickBuild" description="Compile the java source and put in Tomcat working directory">
  	 	<echo message="Compiling Java code."/>
     	<copy todir="${lastbuild}" >
            <fileset dir="${sourcedir}" excludes="**/Thumbs.db"/>
        </copy>

     	<javac srcdir="${javasrc}" destdir="${quickbuild.compiled.destination.directory}" excludes="**.x" debug="on" />
		<copy todir="${quickbuild.tomcat.root.directory}">
			<fileset dir="${lastbuild}">
			</fileset>
		</copy>
		<!--
		<ant antfile="TomcatDeploy.xml" target="reloadApp" inheritAll="true"/>
		-->
	</target>
    

    

</project>
