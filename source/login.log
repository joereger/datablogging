<%@ page import="reger.core.db.Db"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.PUBLICSITE;
pageProps.isPasswordProtected = false;
pageProps.adminSection = "LOGIN";
pageProps.trafficType=reger.Vars.TRAFFICTYPEPUBLICMISC;
pageProps.pathToAppRoot="";
/*----------------------------------------------------*/
%>

<%@ include file="globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/
%>
<%

//Get any returnurl
String returnurl = "";
if (request.getParameter("returnurl")!=null){
    returnurl = request.getParameter("returnurl");
}

//Get on with login
boolean loginResult=false;

if (request.getParameter("action")!=null && request.getParameter("action").equals("login")) {
	reger.Accountuser au = new reger.Accountuser(userSession.getAccount().getAccountid());
	userSession.setAccountuser(au);
	loginResult = userSession.getAccountuser().userAuthenticate(request.getParameter("username"), request.getParameter("password"));
    //If successful login
    if (loginResult){
        //Persistent login
        if (request.getParameter("keepmeloggedin")!=null && request.getParameter("keepmeloggedin").equals("1")){
            //Once without the domain being set
            //response.addCookie(reger.PersistentLogin.createPersistentCookie(userSession.getAccountuser().getAccountuserid(), request, false));
            //response.addCookie(reger.PersistentLogin.createPersistentCookie(userSession.getAccountuser().getAccountuserid(), request, true));
            //Get all possible cookies to set
            Cookie[] cookies = reger.PersistentLogin.getPersistentCookies(userSession.getAccountuser().getAccountuserid(), request);
            //Add a cookies to the response
            for (int i = 0; i < cookies.length; i++) {
                Cookie cookie = cookies[i];
                response.addCookie(cookies[i]);
            }

        }
        //Refresh the account after login
        userSession.getAccount().refresh();

    }
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("quicklogin")) {
	reger.Accountuser au = new reger.Accountuser(userSession.getAccount().getAccountid());
	userSession.setAccountuser(au);
	loginResult = userSession.getAccountuser().quickLogLogin(request.getParameter("quicklogin"), userSession.getAccount().getAccountid());
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("logout")) {
	//Logout
	userSession.getAccountuser().userLogout();
	//Persistent Logout
	response.addCookie(reger.PersistentLogin.createCookieToClearPersistentLogin(request));
	//If this pl is in forcedlogin mode, redirect to the pl home.  Otherwise, the user won't actually be able to login from the login page.  Whoops.
	if (userSession.getPl().getForcelogintoviewsites()){
	    String port="";
	    if (userSession.getUrlSplitter().getPort()!=80 && userSession.getUrlSplitter().getPort()!=443){
            port = ":"+userSession.getUrlSplitter().getPort();
        }
        response.sendRedirect(reger.Vars.getHttpUrlPrefix()+userSession.getPl().getPlBaseUrl()+port+"/about/index.log");
        return;
    }
}


//Redirect to returnurl, if specified
//if (userSession.getAccountuser().isLoggedIn && !returnurl.equals("")){
//    reger.core.Util.debug(5, "login.log<br>java.net.URLDecoder.decode(returnurl, \"UTF-8\")=" + java.net.URLDecoder.decode(returnurl, "UTF-8"));
//    response.sendRedirect(java.net.URLDecoder.decode(returnurl, "UTF-8"));
//    return;
//}

//Redirect to the user's admin home
if (userSession.getAccountuser().userCanDoAcl("ADMINHOME", userSession.getAccountuser().getAccountid())){
    String msgQueryString = "";
    if (request.getParameter("msg")!=null){
        msgQueryString = "msg="+request.getParameter("msg");
    }
    String friendQueryString = "";
    if (request.getParameter("friendinvitationid")!=null){
        friendQueryString = "&friendinvitationid="+request.getParameter("friendinvitationid");
    }
    String friendKeyQueryString = "";
    if (request.getParameter("friendinvitationkey")!=null){
        friendKeyQueryString = "&friendinvitationkey="+request.getParameter("friendinvitationkey");
    }
    String returnurlQueryString = "";
    if (!returnurl.equals("")){
        returnurlQueryString = "&returnurl="+java.net.URLEncoder.encode(returnurl, "UTF-8");
    }
    //Redirect to the accountuser's admin home page... always
    try{
        reger.core.Util.debug(5, "login.log - user logged in - redirecting to:" + reger.Vars.getHttpUrlPrefix() + userSession.getAccountuser().getSiteRootUrl() +"/myhome/index.log?"+msgQueryString+friendQueryString+friendKeyQueryString+returnurlQueryString);

        response.sendRedirect(reger.Vars.getHttpUrlPrefix() + userSession.getUrlSplitter().getSiterooturlPlusPortNum()+"/myhome/index.log?"+msgQueryString+friendQueryString+friendKeyQueryString+returnurlQueryString);

        return;
    } catch (Exception e){
        reger.core.Util.errorsave(e);
    }
}



mb.append("<br>");

//mb.append("SessionId:" + request.getSession().getId() + "<br>");

mb.append("<form action=login.log method=post>");
mb.append("<input type=hidden name=action value='login'>");
if (!returnurl.equals("")){
    mb.append("<input type=hidden name=returnurl value=\""+reger.core.Util.cleanForHtml(java.net.URLEncoder.encode(returnurl, "UTF-8"))+"\">");
}
mb.append("<input type=hidden name=friendinvitationid value='"+request.getParameter("friendinvitationid")+"'>");
mb.append("<table cellpadding=0 cellspacing=1 border=0 align=center>");


mb.append("<tr>");
mb.append("<td valign=middle align=right>");
mb.append("<font class=mediumfont face=arial size=-1>");
mb.append("&nbsp;");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top align=left>");
if (!loginResult && (request.getParameter("action")!=null && (request.getParameter("action").equals("login") || request.getParameter("action").equals("quicklogin")))) {
	mb.append("<font face=arial size=+2 color=red>Your username/password combination was not found.  Please try again.</font>");
} else if (userSession.getAccountuser().getIsLoggedIn()) {
    mb.append("<font face=arial size=+2 color=black>You are now logged in.</font>");
} else {
    mb.append("<font face=arial size=+2 color=black>Please Log In:</font>");
}
mb.append("</td>");
mb.append("<tr>");


if (!userSession.getAccountuser().getIsLoggedIn()){




    //Main login stuff
    mb.append("<tr>");
    mb.append("<td valign=middle align=right>");
    mb.append("<font class=mediumfont face=arial size=-1>");
    mb.append("<strong>Username:</strong>");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    String incomingUsername = "";
    if (request.getParameter("username")!=null){
        incomingUsername = request.getParameter("username");
    }
    mb.append("<input type='text' name='username' size=10 maxlength=49 style=\"font-size: 18px;\" value=\""+reger.core.Util.cleanForSQL(incomingUsername)+"\">");
    mb.append("</td>");
    mb.append("</tr>");


    mb.append("<tr>");
    mb.append("<td valign=middle align=right>");
    mb.append("<font class=mediumfont face=arial size=-1>");
    mb.append("<strong>Password:</strong>");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    mb.append("<input type='password' name='password' size=10 maxlength=49 style=\"font-size: 18px;\">");
    mb.append("<br>");
    mb.append("<font class=smallfont face=arial size=-2>");
    mb.append("<a href='"+pageProps.pathToAppRoot+"about/passwordreset1.log'>");
    mb.append("Lost Your Password?");
    mb.append("</a>");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("</tr>");

    mb.append("<tr>");
    mb.append("<td valign=middle align=right>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    mb.append("<input type='checkbox' name='keepmeloggedin' value='1'>");
    mb.append("<font class=smallfont face=arial size=-2>");
    mb.append("<strong>Stay Logged-In on this Computer Until I Log Out</strong>");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("</tr>");


    mb.append("<tr>");
    mb.append("<td valign=top align=left>");
    mb.append("<font class=mediumfont face=arial size=-1>");
    mb.append("&nbsp;");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    mb.append("<input type='submit' value='Log In'>");
    mb.append("</form>");
    mb.append("</td>");
    mb.append("</tr>");


}

//Quick pass
//-----------------------------------
//-----------------------------------
String[][] rstQuickLogin= Db.RunSQL("SELECT logid FROM megalog WHERE password<>'' AND accountid='"+userSession.getAccount().getAccountid()+"'");
//-----------------------------------
//-----------------------------------
if (rstQuickLogin!=null && rstQuickLogin.length>0){
	mb.append("<tr>");
    mb.append("<td valign=top align=left>");
    mb.append("<font class=mediumfont face=arial size=+1>");
    mb.append("&nbsp;");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    mb.append("<font face=arial size=+2 color=black>");
    mb.append("Or QuickLogin:");
    mb.append("</font>");
    mb.append("<br>");
    mb.append("<font face=arial size=-2 color=black>");
    mb.append("If you have only been given a single password, enter it here.  If you have a full account, entering only the password will not get you in.  QuickPasswords are for sharing web logs to extended groups.");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<tr>");

	mb.append("<tr>");
    mb.append("<td valign=middle align=right>");
    mb.append("<form action=login.log method=post>");
    mb.append("<input type=hidden name=action value='quicklogin'>");
    mb.append("<font class=mediumfont face=arial size=-1>");
    mb.append("<strong>QuickPassword:</strong>");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    mb.append("<input type='text' name='quicklogin' size=10 maxlength=49>");
    mb.append("</td>");
    mb.append("<tr>");

    mb.append("<tr>");
    mb.append("<td valign=top align=left>");
    mb.append("<font class=mediumfont face=arial size=-1>");
    mb.append("&nbsp;");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td valign=top align=left>");
    mb.append("<input type='submit' value='Log In'>");
    mb.append("</form>");
    mb.append("</td>");
    mb.append("<tr>");
}






mb.append("</td>");
mb.append("</tr>");
mb.append("</table>");


mb.append(userSession.getAccountuser().thingsUserCanAccessHtml(request.isSecure()));








%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");

%>

<%@ include file="globalfooter.jsp" %>

