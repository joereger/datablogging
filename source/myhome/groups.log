<%@ page import="reger.core.db.Db,
                 org.apache.xmlrpc.XmlRpcClient,
                 java.util.Vector,
                 java.util.Hashtable,
                 reger.PrivateLabel,
                 reger.core.db.Db"%>
<%@ page import="reger.groups.Group"%>
<%@ page import="reger.core.ValidationException"%>
<%@ page import="reger.groups.GroupMembership"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "Groups";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "groups";
pageProps.aclObjectName = "MANAGEGROUPS";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
pageProps.helpText="Groups allow you to collaborate and share with others who share similar interests.";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%

/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/




//Leavegroup
if (pageProps.action.equals("leavegroup")){

}



//New Group
if (pageProps.action.equals("newgroup")){
    //Create the group
    Group newgroup = new Group();
    newgroup.setName(request.getParameter("name"));
    newgroup.setDescription(request.getParameter("description"));
    if (request.getParameter("entriesareprivate")!=null && request.getParameter("entriesareprivate").equals("1")){
        newgroup.setEntriesareprivate(true);
    } else {
        newgroup.setEntriesareprivate(false);
    }
    if (request.getParameter("membershipismoderated")!=null && request.getParameter("membershipismoderated").equals("1")){
        newgroup.setMembershipismoderated(true);
    } else {
        newgroup.setMembershipismoderated(false);
    }
    newgroup.setAccountuserid(userSession.getAccountuser().getAccountuserid());
    newgroup.setPlid(userSession.getPl().getPlid());
    //Create the groupmembership
    GroupMembership groupMembership = new GroupMembership();
    groupMembership.setAccountuserid(userSession.getAccountuser().getAccountuserid());
    groupMembership.setIsapproved(true);
    groupMembership.setIsmoderator(true);
    groupMembership.setSharemembershippublicly(true);
    try{
        newgroup.save();
        groupMembership.setGroupid(newgroup.getGroupid());
        groupMembership.save();
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Your new group called '"+newgroup.getName()+"' has been saved!"));
    } catch (ValidationException vex){
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, vex.getErrorsAsSingleString()));
    }
}





mb.append("<table cellpadding=10 cellspacing=0 width=100% border=0>");
mb.append("<tr>");
mb.append("<td width=33% valign=top>");

mb.append(reger.ui.BubbleBox.start("Find Groups to Join", pageProps.pathToAppRoot));
mb.append("<br>");
mb.append("<form action='groups-find.log' method=post>");
mb.append("<input type=hidden name=action value='searchgroups'>");
mb.append("<input type=textbox name=searchterms value='' size=35 maxlength=255>");
mb.append("<input type=submit value='Search'>");
mb.append("</form>");
mb.append("<font face=arial size=-2>");
mb.append("Search for things that interest you. For example, 'Soccer' or 'Triathlon' or 'Birds'. Or search on your location. Or somebody's name. Or a TV Show.");
mb.append("</font>");
mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));

mb.append("<br><br>");

mb.append(reger.ui.BubbleBox.start("Create a New Group", pageProps.pathToAppRoot));
mb.append("<br>");
mb.append("<form action='groups.log' method=post>");
mb.append("<input type=hidden name=action value='newgroup'>");
mb.append("<table cellpadding=10 cellspacing=2 width=100% border=0>");


mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Group Name</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<input type=text name=name size=10 maxlength=50 style=\"font-size: 10px;\">");
mb.append("<br>");
mb.append("<font face=arial size=-2>");
mb.append("Note: group name will be public even if group is members-only.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Group Description</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<input type=text name=description size=20 maxlength=255 style=\"font-size: 10px;\">");
mb.append("<br>");
mb.append("<font face=arial size=-2>");
mb.append("Note: group description will be public even if group is members-only.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Viewing Entries</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<font face=arial size=-2>");
mb.append("<input type=radio name=entriesareprivate value='0' checked>");
mb.append("<img src='../images/icon-public.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Public, anybody on the web.");
mb.append("<br>");
mb.append("<input type=radio name=entriesareprivate value='1'>");
mb.append("<img src='../images/icon-private.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Private, only members.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Membership</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<font face=arial size=-2>");
mb.append("<input type=radio name=membershipismoderated value='0' checked>");
mb.append("<img src='../images/icon-public.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Anybody can join.");
mb.append("<br>");
mb.append("<input type=radio name=membershipismoderated value='1'>");
mb.append("<img src='../images/icon-private.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Members must be approved.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");


mb.append("<tr>");
mb.append("<td valign=top>");
mb.append("<font face=arial size=-1>");
mb.append("");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<input type=submit value='Create Group' style=\"font-size: 10px;\">");
mb.append("</td>");
mb.append("</tr>");


mb.append("</table>");
mb.append("</form>");
mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));




mb.append("</td>");
mb.append("<td valign=top>");

mb.append(reger.ui.BubbleBox.start("Your Groups", pageProps.pathToAppRoot));


mb.append("<table cellpadding=8 cellspacing=2 width=100% border=0>");

//-----------------------------------
//-----------------------------------
String[][] rstGroups= Db.RunSQL("SELECT groupmembership.groupid, groups.name, groupmembership.groupmembershipid FROM groupmembership, pl, groups WHERE groupmembership.accountuserid='"+userSession.getAccountuser().getAccountuserid()+"' AND " + userSession.getPl().getPeerSql() + " AND groups.plid=pl.plid AND groups.groupid=groupmembership.groupid ORDER BY groups.name ASC");
//-----------------------------------
//-----------------------------------
if (rstGroups!=null && rstGroups.length>0){
	for(int i=0; i<rstGroups.length; i++){

	    Group group = new Group(Integer.parseInt(rstGroups[i][0]));
	    GroupMembership groupMembership = new GroupMembership(Integer.parseInt(rstGroups[i][2]));


	    mb.append("<tr>");

        mb.append("<td valign=top>");
        mb.append("<a href='group-view.log?groupid="+group.getGroupid()+"'>");
        mb.append("<font face=arial size=-1>");
        mb.append("<b>");
        mb.append(group.getName());
        mb.append("</b>");
        if(!groupMembership.getIsapproved()){
            mb.append(" [Pending Approval]");
        }
        mb.append("</font>");
        mb.append("</a>");
        mb.append("<br>");
        mb.append("<font face=arial size=-2>");
        mb.append(group.getDescription());
        mb.append("</font>");
        mb.append("</td>");


        mb.append("<td valign=top align=center>");
        mb.append("<font face=arial size=-2>");
        if (group.getEntriesareprivate()){
            mb.append("<img src='../images/icon-private.gif' width='16' height='16' alt='' border='0'><br>Private Reading");
        } else {
            mb.append("<img src='../images/icon-public.gif' width='16' height='16' alt='' border='0'><br>Public Reading");
        }
        mb.append("</font>");
        mb.append("</td>");



        mb.append("<td valign=top align=center>");
        mb.append("<font face=arial size=-2>");
        if (group.getMembershipismoderated()){
            mb.append("<img src='../images/icon-private.gif' width='16' height='16' alt='' border='0'><br>Membership must be approved");
        } else {
            mb.append("<img src='../images/icon-public.gif' width='16' height='16' alt='' border='0'><br>Anybody may join");
        }
        mb.append("</font>");
        mb.append("</td>");





        mb.append("<td valign=top align=center>");
        mb.append("<font face=arial size=-2>");
        mb.append("<a href='people-friends-invite.log?groupid="+group.getGroupid()+"'>");
        mb.append("Invite Friends");
        mb.append("</a>");
        mb.append("</font>");
        mb.append("</td>");

        mb.append("<td valign=top align=center>");
        mb.append("<font face=arial size=-2>");
        mb.append("<a href='groups-editmembership.log?groupmembershipid="+groupMembership.getGroupmembershipid()+"'>");
        mb.append("Edit Membership");
        mb.append("</a>");
        mb.append("</font>");
        mb.append("</td>");


        mb.append("<td valign=top align=center>");
        mb.append("<font face=arial size=-2>");
        if (group.getAccountuserid()==userSession.getAccountuser().getAccountuserid() || groupMembership.getIsmoderator()){
            mb.append("<a href='groups-administer.log?groupmembershipid="+groupMembership.getGroupmembershipid()+"'>");
            mb.append("Administer Group");
            mb.append("</a>");
        }
        mb.append("</font>");
        mb.append("</td>");


//        mb.append("<td valign=top align=center>");
//        mb.append("<font face=arial size=-2>");
//        mb.append("<a href='"+pageProps.pathToAppRoot+"groups/rss-group.log?groupid="+group.getGroupid()+"'>");
//        mb.append("<img src='../images/xml-newsfeed.png' alt='' border='0'>");
//        mb.append("</a>");
//        mb.append("</font>");
//        mb.append("</td>");


        mb.append("</tr>");
	}
} else {
    mb.append("<tr>");
    mb.append("<td valign=top>");
    mb.append("<font face=arial size=-2>");
    mb.append("You have not yet joined any groups.");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("</tr>");
}

mb.append("</table>");

mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));

mb.append("</td>");
mb.append("</tr>");
mb.append("</table>");


%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>


<%@ include file="../globalfooter.jsp" %>
