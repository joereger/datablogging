<%@ page import="reger.core.db.Db" %>
<%@ page import="reger.Entry" %>
<%@ page import="reger.cache.EntryCache" %>
<%@ page import="reger.Log" %>
<%@ page import="reger.cache.LogCache" %>
<%@ page import="reger.core.ValidationException" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="reger.InfoBox"%>
<%@ page import="java.util.Iterator"%>
<%@ page import="reger.poll.Poll"%>
<%@ page import="reger.poll.PollFormHtml"%>
<%@ page import="reger.poll.PollResultsHtml"%>
<%@ page import="reger.cache.EntryCache"%>
<%@ page import="reger.cache.LogCache"%>


<%
/*----------------------------------------------------*/
/*                  Main Body                         */
    //StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/
    String eventid = request.getParameter("eventid");
    if (eventid == null || !reger.core.Util.isinteger(eventid)) {
        response.sendRedirect("index.log");
        return;
    }

    Entry entry = new Entry(Integer.parseInt(request.getParameter("eventid")));
    Log log = LogCache.get(entry.logid);
    if (!userSession.getAccountuser().userCanViewLog(log.getLogid())){
        response.sendRedirect("index.log");
        return;
    }

    if (pageProps.action.equals("submitadditionalinfo")) {
        //Groups
        try {
            ArrayList<Integer> groupids = new ArrayList<Integer>();
            if (request.getParameterValues("groupid") != null) {
                String[] inGroups = request.getParameterValues("groupid");
                for (int i = 0; i < inGroups.length; i++) {
                    if (reger.core.Util.isinteger(inGroups[i])) {
                        groupids.add(Integer.parseInt(inGroups[i]));
                    }
                }
            }
            entry.groupids = groupids;
            entry.editEntryAll(userSession.getAccount(), userSession.getAccountuser(), userSession.getPl());
            EntryCache.flush(entry.eventid);
        } catch (ValidationException vex) {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error:<br><br>" + vex.getErrorsAsSingleString()));
        }

        //Polls
        if (request.getParameter("pollid")!=null && reger.core.Util.isinteger(request.getParameter("pollid"))){
            response.sendRedirect("entries-poll-settings.log?eventid=" + entry.eventid + "&pollid="+request.getParameter("pollid"));
            return;
        }

        response.sendRedirect("index.log?msg=entryediteddone&eventid=" + entry.eventid + "&logid=" + entry.logid);
        return;
    }


    if (pageProps.action.equals("")) {
        boolean haveSomethingToAdd = false;

        afterPost.append("<br>");
        //afterPost.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));

        //afterPost.append(InfoBox.get(InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Your entry has been saved!  You can now add optional features to your post.  <a href='index.log?msg=entryedited&eventid=" + entry.eventid + "&logid=" + entry.logid+"'>Skip</a>"));

        afterPost.append("<form action=index.log method=post>");
        afterPost.append("<input type=hidden name=action value='submitadditionalinfo'>");
        afterPost.append("<input type=hidden name=msg value='entryedited'>");
        afterPost.append("<input type=hidden name=eventid value='" + entry.eventid + "'>");
        afterPost.append("<input type=hidden name=logid value='" + entry.logid + "'>");


        afterPost.append("<table cellpadding=10 cellspacing=0 border=0>");


        //Begin Groups
        if (userSession.getAccountuser().userCanDoAcl("POSTENTRYTOGROUP", userSession.getAccount().getAccountid())) {
            haveSomethingToAdd = true;
            //afterPost.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));
            //afterPost.append("<table cellpadding=10 cellspacing=0 border=0>");
            afterPost.append("<tr>");
            afterPost.append("<td align=left valign=top>");
            //afterPost.append("<img src='../images/groups-lg.gif' align=left>");
            afterPost.append("</td>");
            afterPost.append("<td align=right valign=top>");
            afterPost.append("<font face=arial size=+2><b>");
            afterPost.append("Groups");
            afterPost.append("</b></font><br><font face=arial size=-2><b>");
            afterPost.append("Groups allow you to share posts<br> with people who have common interests.<br>Groups can be public or private.");
            afterPost.append("</b></font></td>");
            afterPost.append("<td align=left valign=top>");
            afterPost.append("");
            //Get all groups this accountuser is subscribed to
            //-----------------------------------
            //-----------------------------------
            String[][] rstGroups = Db.RunSQL("SELECT groups.groupid, groups.name FROM groupmembership, groups  WHERE groups.groupid=groupmembership.groupid AND groupmembership.accountuserid='" + userSession.getAccountuser().getAccountuserid() + "' ORDER BY name ASC");
            //-----------------------------------
            //-----------------------------------
            if (rstGroups != null && rstGroups.length > 0) {


                for (int i = 0; i < rstGroups.length; i++) {
                    afterPost.append("<input type=checkbox name=groupid value='" + rstGroups[i][0] + "'");
                    if (entry.isInGroup(Integer.parseInt(rstGroups[i][0]))) {
                        afterPost.append(" checked ");
                    }
                    afterPost.append(" >");
                    afterPost.append(" ");
                    afterPost.append("<font face=arial size=-1><b>");
                    afterPost.append(rstGroups[i][1]);
                    afterPost.append("</b></font>");
                    afterPost.append("<br>");
                }

                if (log.getLogaccess() == reger.Vars.LOGACCESSPRIVATE) {
                    afterPost.append("<img src='" + pageProps.pathToAppRoot + "images/info-icon.gif' border=0>");
                    afterPost.append(" ");
                    afterPost.append("<font face=arial size=-2>");
                    afterPost.append("Note: posting entries from private logs (like this one) to groups will make it visible to readers and members of the group.  You are sharing something otherwise private with the group.  Readers of the group will not be able to view other entries in the this private log.  You're granting them a pass for this single entry.");
                    afterPost.append("</font>");
                }

            } else {
                afterPost.append("<font face=arial size=-2>");
                afterPost.append("You're not subscribed to any groups.  Groups allow you and your friends to share blog posts.");
                afterPost.append("<br><br>");
                afterPost.append("Click <a href='groups.log'>here</a> to find groups to join or create one of your own.");
                afterPost.append("</font>");
            }
            afterPost.append("</td>");
            afterPost.append("</tr>");
            //afterPost.append("</table>");
            //afterPost.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
        }
        //End Groups

        // Begin Poll
        if (1==2){
        afterPost.append("<br>");
        //afterPost.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));
        //afterPost.append("<table cellpadding=10 cellspacing=0 border=0>");
        afterPost.append("<tr>");
        afterPost.append("<td align=left valign=top>");
        //afterPost.append("<img src='../images/poll-icon.gif' align=left>");
        afterPost.append("</td>");
        afterPost.append("<td align=right valign=top>");
        afterPost.append("<font face=arial size=+2><b>");
        afterPost.append("Polls");
        afterPost.append("</b></font><br><font face=arial size=-2><b>");
        afterPost.append("Polls allow you to get feedback from your readers.");
        afterPost.append("</b></font></td>");
        afterPost.append("<td align=left valign=top>");
        afterPost.append("<input type=radio name=pollid value=0> ");
        afterPost.append("<font face=arial size=-1><b>");
        afterPost.append("Create a new poll");
        afterPost.append("</b></font>");
        if (entry.getPolls().size()>0){
            for (Iterator it = entry.getPolls().iterator(); it.hasNext(); ) {
                Poll poll = (Poll)it.next();
                afterPost.append("<br><input type=radio name=pollid value="+poll.getPollid()+"> ");
                afterPost.append("<font face=arial size=-1><b>");
                afterPost.append("Edit Poll: \""+poll.getQuestion()+"\"");
                afterPost.append("</b></font>");
            }

        }
        afterPost.append("</td>");
        afterPost.append("</tr>");
        //afterPost.append("</table>");
        //afterPost.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
        // End Poll


        //afterPost.append("<table cellpadding=10 cellspacing=0 border=0>");
        afterPost.append("<tr>");
        afterPost.append("<td align=left valign=top>");
        //afterPost.append("<img src='../images/groups-lg.gif' align=left>");
        afterPost.append("</td>");
        afterPost.append("<td align=right valign=top>");
        afterPost.append("<font face=arial size=+2><b>");
        afterPost.append("</b></font></td>");
        afterPost.append("<td align=left valign=top>");
        afterPost.append("<input type=submit value='Add Optional Info'>");
        afterPost.append("</td>");
        afterPost.append("</tr>");
        afterPost.append("</table>");
        

        afterPost.append("</form>");

        //afterPost.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));


        if (!haveSomethingToAdd) {
            response.sendRedirect("index.log?msg=entryediteddone&eventid=" + entry.eventid + "&logid=" + entry.logid);
            return;
        }
    }


%>


