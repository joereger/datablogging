<%@ page import="reger.core.db.Db" %>
<%@ page import="reger.Entry" %>
<%@ page import="reger.cache.EntryCache" %>
<%@ page import="reger.Log" %>
<%@ page import="reger.cache.LogCache" %>
<%@ page import="reger.core.ValidationException" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="reger.InfoBox"%>
<%@ page import="java.util.Iterator"%>
<%@ page import="reger.poll.Poll"%>
<%@ page import="reger.poll.PollFormHtml"%>
<%@ page import="reger.poll.PollResultsHtml"%>
<%
    /*----------------------------------------------------*/
/*                  Page Config                       */
    reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
    pageProps.siteSection = pageProps.ADMINSITE;
    pageProps.isPasswordProtected = true;
    pageProps.navButtonName = "entries";
    pageProps.aclObjectName = "ADDEDITENTRIES";
    pageProps.isLogidRequired = true;
    pageProps.trafficType = reger.Vars.TRAFFICTYPEADMINLOGSECTION;
    pageProps.pathToAppRoot = "../";
//pageProps.onloadJavascriptMethod = "makeFormDraggable();";
    pageProps.helpText = "This page allows you to add or edit weblog entries.  Once you're done editing, click to Save the Entry.<br><br>Below the save button you'll find a number of important extended properties that are related to this entry.  Explore these special features... they can dramatically improve your weblogging experience.";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
    /*----------------------------------------------------*/
/*                  Main Body                         */
    StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/
    String eventid = request.getParameter("eventid");
    if (eventid == null || !reger.core.Util.isinteger(eventid)) {
        response.sendRedirect("index.log");
        return;
    }

    Entry entry = new Entry(Integer.parseInt(request.getParameter("eventid")));
    Log log = LogCache.get(entry.logid);
    if (!userSession.getAccountuser().userCanViewLog(log.getLogid())){
        response.sendRedirect("index.log");
        return;
    }

    if (pageProps.action.equals("submit")) {
        //Groups
        try {
            ArrayList<Integer> groupids = new ArrayList<Integer>();
            if (request.getParameterValues("groupid") != null) {
                String[] inGroups = request.getParameterValues("groupid");
                for (int i = 0; i < inGroups.length; i++) {
                    if (reger.core.Util.isinteger(inGroups[i])) {
                        groupids.add(Integer.parseInt(inGroups[i]));
                    }
                }
            }
            entry.groupids = groupids;
            entry.editEntryAll(userSession.getAccount(), userSession.getAccountuser(), userSession.getPl());
            EntryCache.flush(entry.eventid);
        } catch (ValidationException vex) {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error:<br><br>" + vex.getErrorsAsSingleString()));
        }

        //Polls
        if (request.getParameter("pollid")!=null && reger.core.Util.isinteger(request.getParameter("pollid"))){
            response.sendRedirect("entries-poll-settings.log?eventid=" + entry.eventid + "&pollid="+request.getParameter("pollid"));
            return;
        }

        response.sendRedirect("index.log?msg=entryedited&eventid=" + entry.eventid + "&logid=" + entry.logid);
        return;
    }


    if (pageProps.action.equals("")) {
        boolean haveSomethingToAdd = false;

        mb.append("<br>");
        mb.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));

        mb.append(InfoBox.get(InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Your entry has been saved!  You can now add optional features to your post.  <a href='index.log?msg=entryedited&eventid=" + entry.eventid + "&logid=" + entry.logid+"'>Skip</a>"));

        mb.append("<form action=entry-additionalinfo.log method=post>");
        mb.append("<input type=hidden name=action value='submit'>");
        mb.append("<input type=hidden name=eventid value='" + entry.eventid + "'>");
        mb.append("<input type=hidden name=logid value='" + entry.logid + "'>");
        mb.append("<table cellpadding=10 cellspacing=0 border=0>");


        //Begin Groups
        if (userSession.getAccountuser().userCanDoAcl("POSTENTRYTOGROUP", userSession.getAccount().getAccountid())) {
            haveSomethingToAdd = true;
            //mb.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));
            //mb.append("<table cellpadding=10 cellspacing=0 border=0>");
            mb.append("<tr>");
            mb.append("<td align=left valign=top>");
            mb.append("<img src='../images/groups-lg.gif' align=left>");
            mb.append("</td>");
            mb.append("<td align=right valign=top>");
            mb.append("<font face=arial size=+2><b>");
            mb.append("Groups");
            mb.append("</b></font><br><font face=arial size=-2><b>");
            mb.append("Groups allow you to share posts<br> with people who have common interests.<br>Groups can be public or private.");
            mb.append("</b></font></td>");
            mb.append("<td bgcolor='#ffffff' align=left valign=top class=logentrycontent>");
            mb.append("");
            //Get all groups this accountuser is subscribed to
            //-----------------------------------
            //-----------------------------------
            String[][] rstGroups = Db.RunSQL("SELECT groups.groupid, groups.name FROM groupmembership, groups  WHERE groups.groupid=groupmembership.groupid AND groupmembership.accountuserid='" + userSession.getAccountuser().getAccountuserid() + "' ORDER BY name ASC");
            //-----------------------------------
            //-----------------------------------
            if (rstGroups != null && rstGroups.length > 0) {


                for (int i = 0; i < rstGroups.length; i++) {
                    mb.append("<input type=checkbox name=groupid value='" + rstGroups[i][0] + "'");
                    if (entry.isInGroup(Integer.parseInt(rstGroups[i][0]))) {
                        mb.append(" checked ");
                    }
                    mb.append(" >");
                    mb.append(" ");
                    mb.append("<font face=arial size=-1><b>");
                    mb.append(rstGroups[i][1]);
                    mb.append("</b></font>");
                    mb.append("<br>");
                }

                if (log.getLogaccess() == reger.Vars.LOGACCESSPRIVATE) {
                    mb.append("<img src='" + pageProps.pathToAppRoot + "images/info-icon.gif' border=0>");
                    mb.append(" ");
                    mb.append("<font face=arial size=-2>");
                    mb.append("Note: posting entries from private logs (like this one) to groups will make it visible to readers and members of the group.  You are sharing something otherwise private with the group.  Readers of the group will not be able to view other entries in the this private log.  You're granting them a pass for this single entry.");
                    mb.append("</font>");
                }

            } else {
                mb.append("<font face=arial size=-2>");
                mb.append("You're not subscribed to any groups.  Groups allow you and your friends to share blog posts.");
                mb.append("<br><br>");
                mb.append("Click <a href='groups.log'>here</a> to find groups to join or create one of your own.");
                mb.append("</font>");
            }
            mb.append("</td>");
            mb.append("</tr>");
            //mb.append("</table>");
            //mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
        }
        //End Groups

        // Begin Poll
        mb.append("<br>");
        //mb.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));
        //mb.append("<table cellpadding=10 cellspacing=0 border=0>");
        mb.append("<tr>");
        mb.append("<td align=left valign=top>");
        mb.append("<img src='../images/poll-icon.gif' align=left>");
        mb.append("</td>");
        mb.append("<td align=right valign=top>");
        mb.append("<font face=arial size=+2><b>");
        mb.append("Polls");
        mb.append("</b></font><br><font face=arial size=-2><b>");
        mb.append("Polls allow you to get feedback from your readers.");
        mb.append("</b></font></td>");
        mb.append("<td bgcolor='#ffffff' align=left valign=top class=logentrycontent>");
        mb.append("<input type=radio name=pollid value=0> ");
        mb.append("<font face=arial size=-1><b>");
        mb.append("Create a new poll");
        mb.append("</b></font>");
        if (entry.getPolls().size()>0){
            for (Iterator it = entry.getPolls().iterator(); it.hasNext(); ) {
                Poll poll = (Poll)it.next();
                mb.append("<br><input type=radio name=pollid value="+poll.getPollid()+"> ");
                mb.append("<font face=arial size=-1><b>");
                mb.append("Edit Poll: \""+poll.getQuestion()+"\"");
                mb.append("</b></font>");
            }

        }
        mb.append("</td>");
        mb.append("</tr>");
        //mb.append("</table>");
        //mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
        // End Poll


        //mb.append("<table cellpadding=10 cellspacing=0 border=0>");
        mb.append("<tr>");
        mb.append("<td align=left valign=top>");
        //mb.append("<img src='../images/groups-lg.gif' align=left>");
        mb.append("</td>");
        mb.append("<td align=right valign=top>");
        mb.append("<font face=arial size=+2><b>");
        mb.append("</b></font></td>");
        mb.append("<td bgcolor='#ffffff' align=left valign=top class=logentrycontent>");
        mb.append("<input type=submit value='Continue'>");
        mb.append("</td>");
        mb.append("</tr>");



        mb.append("</table>");


        mb.append("</form>");

        mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));


        if (!haveSomethingToAdd) {
            response.sendRedirect("index.log?msg=entryedited&eventid=" + entry.eventid + "&logid=" + entry.logid);
            return;
        }
    }


%>

<%
    /*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/


%>


<%@ include file="../globalfooter.jsp" %>
