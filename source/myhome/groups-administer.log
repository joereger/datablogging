<%@ page import="reger.core.db.Db,
                 org.apache.xmlrpc.XmlRpcClient,
                 java.util.Vector,
                 java.util.Hashtable,
                 reger.core.db.Db"%>
<%@ page import="reger.groups.GroupMembership"%>
<%@ page import="reger.groups.Group"%>
<%@ page import="reger.core.ValidationException"%>
<%@ page import="reger.Accountuser"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "Administer Group";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "groups";
pageProps.aclObjectName = "MANAGEGROUPS";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%

/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/


GroupMembership groupMembership = null;
if(request.getParameter("groupmembershipid")!=null && reger.core.Util.isinteger(request.getParameter("groupmembershipid"))){
    groupMembership = new GroupMembership(Integer.parseInt(request.getParameter("groupmembershipid")));
}

if (groupMembership==null || groupMembership.getAccountuserid()!=userSession.getAccountuser().getAccountuserid()){
    response.sendRedirect("groups.log");
    return;
}

Group group = new Group(groupMembership.getGroupid());

if (group.getAccountuserid()!=userSession.getAccountuser().getAccountuserid() && !groupMembership.getIsmoderator()){
    response.sendRedirect("groups.log");
    return;
}


if (pageProps.action.equals("editgroup")){
    group.setName(request.getParameter("name"));
    group.setDescription(request.getParameter("description"));
    if (request.getParameter("entriesareprivate")!=null && request.getParameter("entriesareprivate").equals("1")){
        group.setEntriesareprivate(true);
    } else {
        group.setEntriesareprivate(false);
    }
    if (request.getParameter("membershipismoderated")!=null && request.getParameter("membershipismoderated").equals("1")){
        group.setMembershipismoderated(true);
    } else {
        group.setMembershipismoderated(false);
    }
    try{
        group.save();
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "The changes have been saved!"));
    } catch (ValidationException vex){
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error:<br>"+vex.getErrorsAsSingleString()));
    }
}

if (pageProps.action.equals("revokemoderator")){
    GroupMembership gmActedOn = null;
    if(request.getParameter("groupmembershipidtorevoke")!=null && reger.core.Util.isinteger(request.getParameter("groupmembershipidtorevoke"))){
        gmActedOn = new GroupMembership(Integer.parseInt(request.getParameter("groupmembershipidtorevoke")));
        if (group.getAccountuserid()!=gmActedOn.getAccountuserid()){
            gmActedOn.setIsmoderator(false);
            try{
                gmActedOn.save();
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Moderator privileges revoked!"));
            } catch (ValidationException vex){
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error:<br>"+vex.getErrorsAsSingleString()));
            }
        } else {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  You can't remove group owner."));
        }
    }
}

if (pageProps.action.equals("grantmoderator")){
    GroupMembership gmActedOn = null;
    if(request.getParameter("groupmembershipidtogrant")!=null && reger.core.Util.isinteger(request.getParameter("groupmembershipidtogrant"))){
        gmActedOn = new GroupMembership(Integer.parseInt(request.getParameter("groupmembershipidtogrant")));
        if (group.getAccountuserid()!=gmActedOn.getAccountuserid()){
            gmActedOn.setIsmoderator(true);
            try{
                gmActedOn.save();
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Moderator privileges granted!"));
            } catch (ValidationException vex){
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error:<br>"+vex.getErrorsAsSingleString()));
            }
        }
    }
}

if (pageProps.action.equals("approverequest")){
    GroupMembership gmActedOn = null;
    if(request.getParameter("groupmembershipidtoapprove")!=null && reger.core.Util.isinteger(request.getParameter("groupmembershipidtoapprove"))){
        gmActedOn = new GroupMembership(Integer.parseInt(request.getParameter("groupmembershipidtoapprove")));
        if (group.getAccountuserid()!=gmActedOn.getAccountuserid()){
            gmActedOn.setIsapproved(true);
            try{
                gmActedOn.save();
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Membership approved!"));
            } catch (ValidationException vex){
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error:<br>"+vex.getErrorsAsSingleString()));
            }
        }
    }
}

if (pageProps.action.equals("declinerequest")){
    GroupMembership gmActedOn = null;
    if(request.getParameter("groupmembershipidtodecline")!=null && reger.core.Util.isinteger(request.getParameter("groupmembershipidtodecline"))){
        gmActedOn = new GroupMembership(Integer.parseInt(request.getParameter("groupmembershipidtodecline")));
        if (group.getAccountuserid()!=gmActedOn.getAccountuserid()){
            gmActedOn.delete();
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Membership declined!"));
        }
    }
}

if (pageProps.action.equals("removemember")){
    GroupMembership gmActedOn = null;
    if(request.getParameter("groupmembershipidtoremove")!=null && reger.core.Util.isinteger(request.getParameter("groupmembershipidtoremove"))){
        gmActedOn = new GroupMembership(Integer.parseInt(request.getParameter("groupmembershipidtoremove")));
        if (group.getAccountuserid()!=gmActedOn.getAccountuserid()){
            gmActedOn.setIsmoderator(false);
            gmActedOn.delete();
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Member removed!"));
        }
    }
}




mb.append("<table cellpadding=10 width=100% cellspacing=0 border=0>");
mb.append("<tr>");
mb.append("<td width=33% valign=top>");
mb.append(reger.ui.BubbleBox.start("Members With Moderator Permission", pageProps.pathToAppRoot));
//-----------------------------------
//-----------------------------------
String[][] rstMod= reger.core.db.Db.RunSQL("SELECT groupmembershipid, accountuser.accountuserid FROM groupmembership, accountuser WHERE groupmembership.accountuserid=accountuser.accountuserid AND groupmembership.groupid='"+group.getGroupid()+"' AND groupmembership.ismoderator='1'");
//-----------------------------------
//-----------------------------------
if (rstMod!=null && rstMod.length>0){
    mb.append("<table cellpadding=10 width=100% cellspacing=0 border=0>");
    for(int i=0; i<rstMod.length; i++){
        GroupMembership tmpGroupMembership = new GroupMembership(Integer.parseInt(rstMod[i][0]));
        Accountuser au = new Accountuser(Integer.parseInt(rstMod[i][1]), true);
        mb.append("<tr>");
        mb.append("<td valign=top>");
        mb.append("<a href='"+au.getSiteRootUrlOfPrimaryAccount(userSession)+"/author.log?accountuserid="+au.getAccountuserid()+"'>");
        mb.append("<img src = '"+au.primaryImage(userSession, true)+"' width=50 border=0 align=left>");
        mb.append("<font face=arial size=-2>");
        mb.append(au.getFriendlyname());
        mb.append("</font>");
        mb.append("</a>");
        mb.append("</td>");
        mb.append("<td valign=top>");
        if (group.getAccountuserid()!=au.getAccountuserid()){
            mb.append("<a href='groups-administer.log?action=revokemoderator&groupmembershipid="+groupMembership.getGroupmembershipid()+"&groupmembershipidtorevoke="+tmpGroupMembership.getGroupmembershipid()+"'>");
            mb.append("<font face=arial size=-2>");
            mb.append("Revoke");
            mb.append("</font>");
            mb.append("</a>");
        }
        mb.append("</td>");
        mb.append("</tr>");
    }
    mb.append("</table>");
}
mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
mb.append("<br><br>");
mb.append(reger.ui.BubbleBox.start("Members", pageProps.pathToAppRoot));
//-----------------------------------
//-----------------------------------
String[][] rstMem = reger.core.db.Db.RunSQL("SELECT groupmembershipid, accountuser.accountuserid FROM groupmembership, accountuser WHERE groupmembership.accountuserid=accountuser.accountuserid AND groupmembership.groupid='"+group.getGroupid()+"' AND groupmembership.isapproved='1'");
//-----------------------------------
//-----------------------------------
if (rstMem !=null && rstMem.length>0){
    mb.append("<table cellpadding=10 width=100% cellspacing=0 border=0>");
    for(int i=0; i<rstMem.length; i++){
        GroupMembership tmpGroupMembership = new GroupMembership(Integer.parseInt(rstMem[i][0]));
        Accountuser au = new Accountuser(Integer.parseInt(rstMem[i][1]), true);
        mb.append("<tr>");
        mb.append("<td valign=top>");
        mb.append("<a href='"+au.getSiteRootUrlOfPrimaryAccount(userSession)+"/author.log?accountuserid="+au.getAccountuserid()+"'>");
        mb.append("<img src = '"+au.primaryImage(userSession, true)+"' width=50 border=0 align=left>");
        mb.append("<font face=arial size=-2>");
        mb.append(au.getFriendlyname());
        mb.append("</font>");
        mb.append("</a>");
        mb.append("</td>");
        mb.append("<td valign=top>");
        if (group.getAccountuserid()!=au.getAccountuserid()){
            mb.append("<a href='groups-administer.log?action=removemember&groupmembershipid="+groupMembership.getGroupmembershipid()+"&groupmembershipidtoremove="+tmpGroupMembership.getGroupmembershipid()+"'>");
            mb.append("<font face=arial size=-2>");
            mb.append("Remove");
            mb.append("</font>");
            mb.append("</a>");
        }
        mb.append("</td>");
        mb.append("<td valign=top>");
        if (group.getAccountuserid()!=au.getAccountuserid()){
            mb.append("<a href='groups-administer.log?action=grantmoderator&groupmembershipid="+groupMembership.getGroupmembershipid()+"&groupmembershipidtogrant="+tmpGroupMembership.getGroupmembershipid()+"'>");
            mb.append("<font face=arial size=-2>");
            mb.append("Make Moderator");
            mb.append("</font>");
            mb.append("</a>");
        }
        mb.append("</td>");
        mb.append("</tr>");
    }
    mb.append("</table>");
}
mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
mb.append("</td>");
mb.append("<td valign=top>");
if(group.getMembershipismoderated()){
    mb.append(reger.ui.BubbleBox.start("Membership Requests", pageProps.pathToAppRoot));
    //-----------------------------------
    //-----------------------------------
    String[][] rstReq = reger.core.db.Db.RunSQL("SELECT groupmembershipid, accountuser.accountuserid FROM groupmembership, accountuser WHERE groupmembership.accountuserid=accountuser.accountuserid AND groupmembership.groupid='"+group.getGroupid()+"' AND groupmembership.isapproved='0'");
    //-----------------------------------
    //-----------------------------------
    if (rstReq !=null && rstReq.length>0){
        mb.append("<table cellpadding=10 width=100% cellspacing=0 border=0>");
        for(int i=0; i<rstReq.length; i++){
            GroupMembership tmpGroupMembership = new GroupMembership(Integer.parseInt(rstReq[i][0]));
            Accountuser au = new Accountuser(Integer.parseInt(rstReq[i][1]), true);
            mb.append("<tr>");
            mb.append("<td valign=top>");
            mb.append("<a href='"+au.getSiteRootUrlOfPrimaryAccount(userSession)+"/author.log?accountuserid="+au.getAccountuserid()+"'>");
            mb.append("<img src = '"+au.primaryImage(userSession, true)+"' width=50 border=0 align=left>");
            mb.append("<font face=arial size=-1>");
            mb.append(au.getFriendlyname());
            mb.append("</font>");
            mb.append("</a>");
            mb.append("</td>");
            mb.append("<td valign=top>");
            if (group.getAccountuserid()!=au.getAccountuserid()){
                mb.append("<a href='groups-administer.log?action=approverequest&groupmembershipid="+groupMembership.getGroupmembershipid()+"&groupmembershipidtoapprove="+tmpGroupMembership.getGroupmembershipid()+"'>");
                mb.append("<font face=arial size=-2>");
                mb.append("Approve");
                mb.append("</font>");
                mb.append("</a>");
            }
            mb.append("</td>");
            mb.append("<td valign=top>");
            if (group.getAccountuserid()!=au.getAccountuserid()){
                mb.append("<a href='groups-administer.log?action=declinerequest&groupmembershipid="+groupMembership.getGroupmembershipid()+"&groupmembershipidtodecline="+tmpGroupMembership.getGroupmembershipid()+"'>");
                mb.append("<font face=arial size=-2>");
                mb.append("Decline");
                mb.append("</a>");
            }
            mb.append("</td>");
            mb.append("</tr>");
        }
        mb.append("</table>");
    } else {
        mb.append("<font face=arial size=-2>");
        mb.append("There are no new membership requests.");
        mb.append("</font>");
    }
    mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
    mb.append("<br><br>");
}

mb.append(reger.ui.BubbleBox.start("Group Properties", pageProps.pathToAppRoot));
mb.append("<br>");
mb.append("<form action='groups-administer.log' method=post>");
mb.append("<input type=hidden name=action value='editgroup'>");
mb.append("<input type=hidden name=groupmembershipid value='"+groupMembership.getGroupmembershipid()+"'>");
mb.append("<table cellpadding=10 cellspacing=2 width=100% border=0>");


mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Group Name</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<input type=text name=name size=10 maxlength=50 value=\""+reger.core.Util.cleanForHtml(group.getName())+"\" style=\"font-size: 10px;\">");
mb.append("<br>");
mb.append("<font face=arial size=-2>");
mb.append("Note: group name will be public even if group is members-only.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Group Description</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<input type=text name=description size=20 maxlength=255 value=\""+reger.core.Util.cleanForHtml(group.getDescription())+"\" style=\"font-size: 10px;\">");
mb.append("<br>");
mb.append("<font face=arial size=-2>");
mb.append("Note: group description will be public even if group is members-only.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Viewing Entries</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<font face=arial size=-2>");
String eapNo = "";
if (!group.getEntriesareprivate()){
    eapNo = "checked";
}
mb.append("<input type=radio name=entriesareprivate value='0' "+eapNo+">");
mb.append("<img src='../images/icon-public.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Public, anybody on the web.");
mb.append("<br>");
String eapYes = "";
if (group.getEntriesareprivate()){
    eapYes = "checked";
}
mb.append("<input type=radio name=entriesareprivate value='1' "+eapYes+">");
mb.append("<img src='../images/icon-private.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Private, only members.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td valign=top bgcolor=#e6e6e6 align=right>");
mb.append("<font face=arial size=-1>");
mb.append("<b>Membership</b>");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<font face=arial size=-2>");
String mimNo = "";
if (!group.getMembershipismoderated()){
    mimNo = "checked";
}
mb.append("<input type=radio name=membershipismoderated value='0' "+mimNo+">");
mb.append("<img src='../images/icon-public.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Anybody can join.");
mb.append("<br>");
String mimYes = "";
if (group.getMembershipismoderated()){
    mimYes = "checked";
}
mb.append("<input type=radio name=membershipismoderated value='1' "+mimYes+">");
mb.append("<img src='../images/icon-private.gif' width='16' height='16' alt='' border='0'>");
mb.append(" Members must be approved.");
mb.append("</font>");
mb.append("</td>");
mb.append("</tr>");


mb.append("<tr>");
mb.append("<td valign=top>");
mb.append("<font face=arial size=-1>");
mb.append("");
mb.append("</font>");
mb.append("</td>");
mb.append("<td valign=top>");
mb.append("<input type=submit value='Edit Group' style=\"font-size: 10px;\">");
mb.append("</td>");
mb.append("</tr>");


mb.append("</table>");
mb.append("</form>");
mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));

mb.append("</td>");
mb.append("</tr>");
mb.append("</table>");







%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>


<%@ include file="../globalfooter.jsp" %>
