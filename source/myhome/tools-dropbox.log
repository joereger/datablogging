<%@ page import="reger.core.db.Db"%>
<%@ page import="reger.Log"%>
<%@ page import="reger.core.*"%>
<%@ page import="reger.cache.*"%>
<%@ page import="java.util.List" %>
<%@ page import="com.dropbox.client2.session.WebAuthSession" %>
<%@ page import="com.dropbox.client2.DropboxAPI" %>
<%@ page import="com.dropbox.client2.session.AppKeyPair" %>
<%@ page import="reger.dropbox.Dropbox" %>
<%@ page import="com.dropbox.client2.session.AccessTokenPair" %>
<%@ page import="java.util.Iterator" %>
<%@ page import="org.apache.jasper.tagplugins.jstl.core.Url" %>
<%@ page import="java.net.URLEncoder" %>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "Dropbox";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "toolsdropbox";
pageProps.aclObjectName = "CUSTOMIZE";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/




mb.append("<br><br>");


if (request.getParameter("action")!=null && request.getParameter("action").equals("unlink")){
    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("DELETE FROM dropbox WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------
    response.sendRedirect(pageProps.pathToAppRoot + "myhome/tools-dropbox.log");
    return;
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("choosepath")){
    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("UPDATE dropbox SET autoblogpath='"+reger.core.Util.cleanForSQL(request.getParameter("path"))+"' WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("chooselogid")){
    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("UPDATE dropbox SET logid='"+reger.core.Util.cleanForSQL(request.getParameter("logid"))+"' WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("processautoblogpath")){
    Dropbox.processAutoBlogPath(userSession.getAccount().getAccountid(), false);
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("processautoblogpathforce")){
    Dropbox.processAutoBlogPath(userSession.getAccount().getAccountid(), true);
}







DropboxAPI<WebAuthSession> api = null;
boolean apiIsGood = false;
try{
    api = Dropbox.getApi(userSession.getAccount().getAccountid());
    String test = api.accountInfo().displayName;
    apiIsGood = true;
} catch (Exception ex){}

if (api==null || !apiIsGood){

    // And later in some initialization function:
    AppKeyPair appKeys = new AppKeyPair(Dropbox.APP_KEY, Dropbox.APP_SECRET);
    WebAuthSession sess = new WebAuthSession(appKeys, Dropbox.ACCESS_TYPE);
    WebAuthSession.WebAuthInfo webauthinfo = sess.getAuthInfo(userSession.getUrlSplitter().getSiterooturl()+"/myhome/tools-dropbox-oauth-redir.log");

    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("UPDATE dropbox SET access_key='"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.key)+"', access_secret='"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.secret)+"' WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------
    if (count==0){
        //-----------------------------------
        //-----------------------------------
        int identity = Db.RunSQLInsert("INSERT INTO dropbox(accountid, access_key, access_secret, autoblogpath, logid) VALUES('"+userSession.getAccount().getAccountid()+"', '"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.key)+"', '"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.secret)+"', '', 0)");
        //-----------------------------------
        //-----------------------------------
    }

    mb.append("<div class=\"row\">");
    mb.append("<div class=\"well span12\">");
    mb.append("<h1>Please <a href=\""+webauthinfo.url+"\">authorize</a> your account.</h1>");
    mb.append("</div>");
    mb.append("</div>");

} else {

    mb.append("<div class=\"row\">");
    mb.append("<div class=\"well span12\">");
        mb.append("<h3>Authenticated to account '"+api.accountInfo().displayName+"' <a href=\""+pageProps.pathToAppRoot+"myhome/tools-dropbox.log?action=unlink\">revoke access</a></h3>");
        //mb.append("<br/>");
        if (Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid())!=null && !Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid()).equals("")){
            mb.append("<a href=\""+pageProps.pathToAppRoot+"myhome/tools-dropbox.log?action=processautoblogpathforce\">Create Blog Posts From '"+Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid())+"' Now</a>");
        }
    mb.append("</div>");
    mb.append("</div>");


    mb.append("<div class=\"well span3\">");
    mb.append("<div class=\"well span2\">");
    mb.append("<h3>Instructions</h3>");
    mb.append("Blogging with Dropbox");
    mb.append("</div>");

    mb.append("<p>Choose a Dropbox directory and Log to blog to.</p>");

    mb.append("<p>Within Dropbox, create directories with names like:");
    mb.append("<br/>2013-02-27-This is a Great Blog Post");
    mb.append("<br/>2013-01-16-Another Blog Post Here");
    mb.append("</p>");

    mb.append("<p>A blog post will be created for each directory and will include the images in that directory.</p>");

    mb.append("</div>");



    mb.append("<div class=\"row\">");
    mb.append("<div class=\"well span4\">");


    mb.append("<div class=\"well span3\">");
    mb.append("<h3>Directory to Blog From</h3>");
    if (Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid())!=null && !Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid()).equals("")){
        mb.append(Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid()));
    } else {
        mb.append("Please choose one below");
    }
    mb.append("</div>");
    mb.append("<br clear='all'>");

    try{

        DropboxAPI.Entry autoblogdir = api.metadata(Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid()), 0, null, true, null);

        String path = "/";
        if (request.getParameter("path")!=null){
            path = request.getParameter("path");
        }

        DropboxAPI.Entry rootdir = api.metadata(path, 0, null, true, null);

        for (Iterator<DropboxAPI.Entry> iterator = rootdir.contents.iterator(); iterator.hasNext();) {

            DropboxAPI.Entry entry = iterator.next();

            if (entry.isDir){
                mb.append("<br/><a href='tools-dropbox.log?path="+ URLEncoder.encode(entry.path, "UTF-8")+"'>"+entry.fileName()+"</a> (<a href='tools-dropbox.log?action=choosepath&path="+ URLEncoder.encode(entry.path, "UTF-8")+"'>Choose</a>)");
            } else {
                mb.append("<br/>"+entry.fileName()+"");
            }

        }

    } catch (Exception ex){
        ex.printStackTrace();
    }
    mb.append("</div>");



    mb.append("<div class=\"well span3\">");


    mb.append("<div class=\"well span2\">");
        mb.append("<h3>Log To Post To</h3>");
        if (Dropbox.getLog(userSession.getAccount().getAccountid())!=null){
            mb.append(Dropbox.getLog(userSession.getAccount().getAccountid()).getName());
        } else {
            mb.append("Please choose one below");
        }
        mb.append("</div>");
        mb.append("<br clear='all'>");

        for (Iterator it = userSession.getAccount().getAlllogsforaccountid().iterator(); it.hasNext(); ) {
           Integer logid = (Integer)it.next();
            Log log = LogCache.get(logid);


            mb.append("<br/><a href='tools-dropbox.log?action=chooselogid&logid="+log.getLogid()+"'>"+log.getName()+"</a>");
        }

    mb.append("</div>");






    mb.append("</div>");


}



%>
<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>


<%@ include file="../globalfooter.jsp" %>
