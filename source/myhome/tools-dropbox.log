<%@ page import="reger.core.db.Db"%>
<%@ page import="reger.core.*"%>
<%@ page import="java.util.List" %>
<%@ page import="com.dropbox.client2.session.WebAuthSession" %>
<%@ page import="com.dropbox.client2.DropboxAPI" %>
<%@ page import="com.dropbox.client2.session.AppKeyPair" %>
<%@ page import="reger.dropbox.Dropbox" %>
<%@ page import="com.dropbox.client2.session.AccessTokenPair" %>
<%@ page import="java.util.Iterator" %>
<%@ page import="org.apache.jasper.tagplugins.jstl.core.Url" %>
<%@ page import="java.net.URLEncoder" %>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "Dropbox";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "toolsdropbox";
pageProps.aclObjectName = "CUSTOMIZE";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/




mb.append("<br><br>");


if (request.getParameter("action")!=null && request.getParameter("action").equals("unlink")){
    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("DELETE FROM dropbox WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------
    response.sendRedirect(pageProps.pathToAppRoot + "myhome/tools-dropbox.log");
    return;
}

if (request.getParameter("action")!=null && request.getParameter("action").equals("choosepath")){

    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("UPDATE dropbox SET autoblogpath='"+reger.core.Util.cleanForSQL(request.getParameter("path"))+"' WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------

}







DropboxAPI<WebAuthSession> api = Dropbox.getApi(userSession.getAccount().getAccountid());

if (api==null){

    // And later in some initialization function:
    AppKeyPair appKeys = new AppKeyPair(Dropbox.APP_KEY, Dropbox.APP_SECRET);
    WebAuthSession sess = new WebAuthSession(appKeys, Dropbox.ACCESS_TYPE);
    WebAuthSession.WebAuthInfo webauthinfo = sess.getAuthInfo("http://"+userSession.getUrlSplitter().getSiterooturl()+"/myhome/tools-dropbox-oauth-redir.log");

    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("UPDATE dropbox SET access_key='"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.key)+"', access_secret='"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.secret)+"' WHERE accountid='"+userSession.getAccount().getAccountid()+"'");
    //-----------------------------------
    //-----------------------------------
    if (count==0){
        //-----------------------------------
        //-----------------------------------
        int identity = Db.RunSQLInsert("INSERT INTO dropbox(accountid, access_key, access_secret, autoblogpath) VALUES('"+userSession.getAccount().getAccountid()+"', '"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.key)+"', '"+reger.core.Util.cleanForSQL(webauthinfo.requestTokenPair.secret)+"', '')");
        //-----------------------------------
        //-----------------------------------
    }

    mb.append("Please <a href=\""+webauthinfo.url+"\">authorize</a> within Dropbox.");

} else {

    mb.append("<h3>Congrats... you're authenticated!</h3>");
    mb.append("<a href=\""+pageProps.pathToAppRoot+"myhome/tools-dropbox.log?action=unlink\">unauthenticate</a><br/>");
    mb.append("Auto-Blog-Path="+Dropbox.getAutoBlogPath(userSession.getAccount().getAccountid()));



    DropboxAPI.Entry autoblogdir = api.metadata(autoblogpath, 0, null, true, null);




    mb.append("<br/><br/><br/>");

    try{




        mb.append("<br/>Dropbox Account: "+api.accountInfo().displayName+"<br/>");

        String path = "/";
        if (request.getParameter("path")!=null){
            path = request.getParameter("path");
        }

        DropboxAPI.Entry rootdir = api.metadata(path, 0, null, true, null);

        for (Iterator<DropboxAPI.Entry> iterator = rootdir.contents.iterator(); iterator.hasNext();) {

            DropboxAPI.Entry entry = iterator.next();

            if (entry.isDir){
                mb.append("<br/><a href='tools-dropbox.log?path="+ URLEncoder.encode(entry.path, "UTF-8")+"'>"+entry.fileName()+"</a> (<a href='tools-dropbox.log?action=choosepath&path="+ URLEncoder.encode(entry.path, "UTF-8")+"'>Use This</a>)");
            } else {
                mb.append("<br/>"+entry.fileName());
            }

        }

    } catch (Exception ex){
        ex.printStackTrace();
    }


}



%>
<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>


<%@ include file="../globalfooter.jsp" %>
