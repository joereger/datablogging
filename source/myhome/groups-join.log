<%@ page import="reger.core.db.Db,
                 org.apache.xmlrpc.XmlRpcClient,
                 java.util.Vector,
                 java.util.Hashtable,
                 reger.core.db.Db"%>
<%@ page import="reger.groups.Group"%>
<%@ page import="reger.groups.GroupMembership"%>
<%@ page import="reger.core.ValidationException"%>
<%@ page import="reger.Accountuser"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "Join Group";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "groups";
pageProps.aclObjectName = "MANAGEGROUPS";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%

/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/


Group group = null;
if(request.getParameter("groupid")!=null && reger.core.Util.isinteger(request.getParameter("groupid"))){
    group = new Group(Integer.parseInt(request.getParameter("groupid")));
} else {
    response.sendRedirect("groups.log");
    return;
}

//@todo check to see if this group is in the pl or a trusted pl peer

//Create the groupmembership
GroupMembership groupMembership = new GroupMembership();
groupMembership.setAccountuserid(userSession.getAccountuser().getAccountuserid());
if (group.getMembershipismoderated()){
    groupMembership.setIsapproved(false);
} else {
    groupMembership.setIsapproved(true);
}
groupMembership.setIsmoderator(false);
groupMembership.setSharemembershippublicly(true);
try{
    groupMembership.setGroupid(group.getGroupid());
    groupMembership.save();
    if(group.getMembershipismoderated()){
        int ownerGroupMembershipId = 0;
        //-----------------------------------
        //-----------------------------------
        String[][] rstOwner= reger.core.db.Db.RunSQL("SELECT groupmembershipid FROM groupmembership WHERE groupid='"+group.getGroupid()+"' AND accountuserid='"+group.getAccountuserid()+"'");
        //-----------------------------------
        //-----------------------------------
        if (rstOwner!=null && rstOwner.length>0){
            ownerGroupMembershipId = Integer.parseInt(rstOwner[0][0]);
        }
        reger.FriendMessage thisMessage = new reger.FriendMessage();
        thisMessage.newMessage(userSession.getAccountuser().getAccountuserid(), new int[]{group.getAccountuserid()}, "Group membership request to: '"+group.getName()+"' from '"+userSession.getAccountuser().getFriendlyname()+"'", "There is a new group membership request for a group that you own.<br><br>Please click <a href='groups-administer.log?groupmembershipid="+ownerGroupMembershipId+"'>here</a> to approve or decline.");
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Membership in '"+group.getName()+"' is moderated.  A request for membership has been sent to the group administrators.<br><br>Click <a href='groups.log'>here</a> to continue."));
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Success!  You are now a member of '"+group.getName()+"'!<br><br>Click <a href='groups.log'>here</a> to continue."));
    }
} catch (ValidationException vex){
    mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There has been an error:<br>" + vex.getErrorsAsSingleString() + "<br><br>Click <a href='groups.log'>here</a> to continue."));
}








%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>


<%@ include file="../globalfooter.jsp" %>
