<%@ page import="reger.poll.PollAnswer" %>
<%@ page import="reger.poll.PollReaderAnswer" %>
<%@ page import="java.util.StringTokenizer" %>
<%@ page import="java.util.HashMap" %>
<%@ page import="java.util.Iterator" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="reger.poll.PollResultsHtml"%>
<%@ page import="reger.cache.EntryCache"%>
<%@ page import="reger.poll.Poll"%>
<%@ page import="reger.InfoBox"%>
<%@ page import="reger.Entry"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection = pageProps.ADMINSITE;
pageProps.title = "Poll Results";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "entriespolls";
pageProps.aclObjectName = "ADDEDITENTRIES";
pageProps.trafficType = reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot = "../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
    StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/


//Security + loading
Poll poll = null;
Entry entry = null;
if (request.getParameter("pollid")!=null && reger.core.Util.isinteger(request.getParameter("pollid"))){
    poll = new Poll(Integer.parseInt(request.getParameter("pollid")));
    entry = EntryCache.get(poll.getEventid());
}
if (!userSession.getAccountuser().userCanViewLog(entry.logid) || entry.accountid!=userSession.getAccount().getAccountid()){
    mb.append(InfoBox.get(InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry.  You don't appear to have permission to access this poll."));
} else {
    mb.append("<br><br>");
    if (poll.getIsopen() && request.getParameter("answer")!=null){
        String addNewTxt = "";
        if (poll.getReaderscanaddownanswer() && poll.getReaderinputismoderated() && request.getParameter("answer").equals("newreaderanswer")){
            addNewTxt = " It will appear once the owner approves it.";
        }
        mb.append(InfoBox.get(InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Your vote has been added!"+addNewTxt));
    }
    if (poll.getIsopen() && request.getParameter("action").equals("commentonpoll")){
        String addNewTxt = "";
        if (poll.getReaderinputismoderated()){
            addNewTxt = " It will appear once the owner approves it.";
        }
        mb.append(InfoBox.get(InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Your comment has been added!"+addNewTxt));
    }
    PollResultsHtml.doVoting(poll, request, response, pageProps, userSession);
    PollResultsHtml.doCommenting(poll, request, response, pageProps, userSession);
    poll.load();
    mb.append(PollResultsHtml.getResults(poll, request, response, pageProps, userSession));
}

%>
<%
    /*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
%>

<%@ include file="../globalfooter.jsp" %>