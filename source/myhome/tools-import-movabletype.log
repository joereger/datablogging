<%@ page import="java.util.Iterator" %>
<%@ page import="java.util.TreeSet" %>
<%@ page import="java.util.TimeZone" %>
<%@ page import="reger.importentries.ImportMovableEntries"%>
<%@ page import="org.apache.commons.fileupload.FileItem"%>
<%@ page import="java.io.InputStream"%>

<%
    /*----------------------------------------------------*/
/*                  Page Config                       */
    reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
    pageProps.siteSection = pageProps.ADMINSITE;
    pageProps.title = "Import From Movable Type";
    pageProps.isPasswordProtected = true;
    pageProps.navButtonName = "importmovabletype";
    pageProps.aclObjectName = "CUSTOMIZE";
    pageProps.trafficType = reger.Vars.TRAFFICTYPEADMINMISC;
    pageProps.pathToAppRoot = "../";
/*----------------------------------------------------*/
%>
<%@ include file="../globalheader.jsp" %>
<%
    /*----------------------------------------------------*/
/*                  Main Body                         */
    StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/

    reger.Upload upload = new reger.Upload(request);
    if ((String) upload.requestParams.get("submit") != null) {
        String logid = (String) upload.requestParams.get("logid");
        FileItem[] fileItems = upload.getFileItems();
        if ((fileItems != null) && (fileItems.length > 0)) {
            for (int i = 0; i < fileItems.length; i++) {
                FileItem fileItem = fileItems[i];
                if ( (fileItem.getFieldName().equals("uploadFile")) && (!fileItem.getName().equals(""))) {
                    boolean success = true;
                    String timezoneid = (String) upload.requestParams.get("timezoneid");
                    InputStream fileStream = fileItem.getInputStream();
                    ImportMovableEntries importEntries = new ImportMovableEntries();
                    try {
                        importEntries.importMovableFromFile(userSession, fileStream, logid, timezoneid);
                    } catch (Exception e) {
                        success = false;
                        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry. The import failed."));
                    }
                    if (success) {
                        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEINFO, pageProps.pathToAppRoot, "The import was successful."));
                    }
                }
                break;
            }
        }
    }

    mb.append("<form action='tools-import-movabletype.log' method=post enctype='multipart/form-data'>");
    mb.append("<table border=0 align=center>");

    mb.append("<tr>");
    mb.append("<td valign=top align=right width=50% bgcolor='#eeeeee'><font face=arial size=-1><strong>Import Movable Type to this log:</strong></font></td>");
    mb.append("<td bgcolor='#ffffff' valign=top align=left>");
    mb.append("<select name=logid><option value=default>Select a log</option>");

    //Retrieving logs for current user
    //-----------------------------------
    //-----------------------------------
    String[][] rstSameType = reger.core.db.Db.RunSQL("SELECT logid, name FROM megalog WHERE " + userSession.getAccountuser().LogsUserCanAdministerQueryend(userSession.getAccount().getAccountid()));
    //-----------------------------------
    //-----------------------------------

    if (rstSameType != null && rstSameType.length > 0) {
        for (int i = 0; i < rstSameType.length; i++) {
            mb.append("<option value=" + rstSameType[i][0] + ">");
            mb.append(rstSameType[i][1]);
            mb.append("</option>");
        }
    } else {
        mb.append("No logs found.");
    }
    mb.append("</select></td>");
    mb.append("</tr>");

    mb.append("<tr>");
    mb.append("<td valign=top align=right width=50% bgcolor='#eeeeee'><font face=arial size=-1><strong>Select your Timezone:</strong></font></td>");
    mb.append("<td bgcolor='#ffffff' valign=top align=left>");
    mb.append("<select name=timezoneid>");
    String[] timezone = TimeZone.getAvailableIDs();
    TreeSet timezoneids = new TreeSet();
    //Add the timezoneid's to a treeset
    for (int i = 0; i < timezone.length; i++) {
        timezoneids.add(timezone[i]);
    }
    //Output to the screen
    for (Iterator iterator = timezoneids.iterator(); iterator.hasNext();) {
        String tzid = (String) iterator.next();
        mb.append("<option value=\"" + reger.core.Util.cleanForHtml(tzid) + "\" ");
        if (tzid.equalsIgnoreCase("GMT")) {
            mb.append("selected");
        }
        mb.append(">");
        mb.append(tzid);
        mb.append("</option>");
    }
    mb.append("</select>");
    mb.append("</td>");
    mb.append("</tr>");

    mb.append("<tr>");
    mb.append("<td valign=top align=right width=50% bgcolor='#eeeeee'><font face=arial size=-1><strong>Upload File:</strong></font></td>");
    mb.append("<td bgcolor='#ffffff' valign=top align=left>");
    mb.append("<input type=file name=uploadFile></td>");
    mb.append("</tr>");

    mb.append("<tr>");
    mb.append("<td bgcolor=#ffffff colspan=2 align=center><input type='submit' name='submit' value='Import Blog Entries'></td>");
    mb.append("</tr>");

    mb.append("</table>");
    mb.append("</form>");






    //Instructions
    mb.append("<font face=arial size=+3 color=#cccccc>");
    mb.append("Instructions:");
    mb.append("</font>");

    mb.append("<br>");
    mb.append("<font face=arial size=+1>");
    mb.append("Step 1: Export entries from your MovableType/TypePad blog");
    mb.append("</font>");
    mb.append("<br>");
    mb.append("<font face=arial size=-1>");
    mb.append("<ol>");
    mb.append("<li>Log in to your MovableType blog.</li>");
    mb.append("<li> From the main menu, click on the \"Manage Weblog\" link for the blog whose entries you want to export.</li>");
    mb.append("<li> Click the \"Import/Export\" button on the left menu.</li>");
    mb.append("<li> Click the \"Export Entries from ...\" link at the bottom of page.</li>");
    mb.append("<li> Now you should see readable text, split over several lines, in your browser. If the text in one long, running line, and if you are using any version of Internet Explorer, then you have a problem. Internet Explorer sometimes treats plaintext as html. To avoid this problem, use a Gecko-based browser, such as Netscape, Mozilla, or FireFox.</li>");
    mb.append("<li> Save the page you see in your browser, with all the entries in text, as a text file with the name \"import.txt\", on your computer.</li>");
    mb.append("</ol>");
    mb.append("</font>");

    mb.append("<br>");
    mb.append("<font face=arial size=+1>");
    mb.append("Step 2: Import entries into this blog");
    mb.append("</font>");
    mb.append("<br>");
    mb.append("<font face=arial size=-1>");
    mb.append("<ol>");
    mb.append("<li>On this page, select the log that you want to import your MovableType entries into</li>");
    mb.append("<li>Select the timezone that is stored in the MovableType file... if unsure, leave as GMT.</li>");
    mb.append("<li>Click the Browse button, locate the import.txt file on your computer</li>");
    mb.append("<li>Click Import Blog Entries</li>");
    mb.append("</ol>");
    mb.append("</font>");

    mb.append("<br>");
    mb.append("<font face=arial size=+1>");
    mb.append("You're done!");
    mb.append("</font>");
%>

<%
    /*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>

<%@ include file="../globalfooter.jsp" %>