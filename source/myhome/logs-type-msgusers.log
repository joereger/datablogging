<%@ page import="reger.core.db.Db,
                 reger.core.Util,
                 java.util.TreeMap,
                 reger.mega.FieldType,
                 reger.mega.FieldLayout,
                 reger.MegaLogType,
                 reger.core.Util"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "<img src='../images/icon-log-type-med-notext.gif' align=top> Delete Log Type";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "logslogtypes";
pageProps.aclObjectName = "CUSTOMIZELOG";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
//pageProps.isLogidRequired=true;
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
    StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/


//Make sure we have an eventtypeid
int eventtypeid=-1;
if (request.getParameter("eventtypeid")!=null && !request.getParameter("eventtypeid").equals("") && Util.isinteger(request.getParameter("eventtypeid"))){
    eventtypeid=Integer.parseInt(request.getParameter("eventtypeid"));
}

//Create a megalogtype
MegaLogType megaLogType = new MegaLogType(eventtypeid);

//Subject & message
String subject="Message to users of the "+megaLogType.getMegalogname()+" log type";
if (request.getParameter("subject")!=null && !request.getParameter("subject").equals("") ){
    subject=request.getParameter("subject");
}

String message="";
if (request.getParameter("message")!=null && !request.getParameter("message").equals("") ){
    message=request.getParameter("message");
}


//Send
if (pageProps.action.equals("sendmessage") && !message.equals("")){
    //Make sure logged-in user is owner of log type
    if (megaLogType.getAccountuserid()==userSession.getAccountuser().getAccountuserid()){
        //Select distinct accounsuserids to send to
        //-----------------------------------
        //-----------------------------------
        String[][] rstUserLogType= Db.RunSQL("SELECT DISTINCT accountuser.accountuserid FROM megalogtype megalogtype, account, pl, accountuser WHERE "+userSession.getPl().getPeerSql()+" AND account.plid=pl.plid AND megalogtype.accountuserid=accountuser.accountuserid AND account.islistedindirectory='1' AND issystemlogtype='0' AND megalogtype.isprivate='0' AND accountuser.accountid=account.accountid AND megalogtype.eventtypeid='"+megaLogType.getEventtypeid()+"'");
        //-----------------------------------
        //-----------------------------------
        if (rstUserLogType!=null && rstUserLogType.length>0){
            //Create the message
            reger.FriendMessage msg = new reger.FriendMessage();
            int[] recipients = new int[0];
            for(int i=0; i<rstUserLogType.length; i++){
                //Add recipient
                recipients = reger.core.Util.addToIntArray(recipients, Integer.parseInt(rstUserLogType[i][0]));
            }
            //Send message
            msg.newMessage(userSession.getAccountuser().getAccountuserid(), recipients, subject, message);
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Your message has been sent."));
        } else {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "There are no users to send this message to because there are no users using this log type."));
        }

    }
}





//Log Header start
String currentNavButtonName = "logs-type-msgusers";
%>
<%@ include file="logs-header.jsp" %>
<%
//Log Header end

int numberofusers = 0;
//-----------------------------------
//-----------------------------------
String[][] rstUserLogType= Db.RunSQL("SELECT count(DISTINCT accountuser.accountuserid) FROM megalogtype megalogtype, account, pl, accountuser WHERE "+userSession.getPl().getPeerSql()+" AND account.plid=pl.plid AND megalogtype.accountuserid=accountuser.accountuserid AND account.islistedindirectory='1' AND issystemlogtype='0' AND megalogtype.isprivate='0' AND accountuser.accountid=account.accountid AND megalogtype.eventtypeid='"+megaLogType.getEventtypeid()+"'");
//-----------------------------------
//-----------------------------------
if (rstUserLogType!=null && rstUserLogType.length>0){
    numberofusers = Integer.parseInt(rstUserLogType[0][0]);
}


StringBuffer info = new StringBuffer();
info.append("There are "+numberofusers+" users, aside from you, who use the \""+megaLogType.getMegalogname()+"\" log type.  Using this page you can send them a message.");
mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEINFO, pageProps.pathToAppRoot, info.toString()));

mb.append("<font face=arial size=-1>");
mb.append("<form action=logs-type-msgusers.log method=post>");
mb.append("<input type=hidden name=eventtypeid value="+megaLogType.getEventtypeid()+">");
mb.append("<input type=hidden name=action value=sendmessage>");
mb.append("<b>Subject:</b>");
mb.append("<br>");
mb.append("<input type=text name=subject size=50 maxlength=255 value=\""+reger.core.Util.cleanForHtml("Message to users of the "+megaLogType.getMegalogname()+" log type")+"\">");
mb.append("<br>");
mb.append("<br>");
mb.append("<b>Message:</b>");
mb.append("<br>");
mb.append("<textarea name=message style=\"width: 100%;\" cols=45 rows=10></textarea>");
mb.append("<br>");
mb.append("<br>");
mb.append("<input type=submit value='Send Message'>");


mb.append("</font>");

mb.append("<br><br>");


//Log Footer start
%>
<%@ include file="logs-footer.jsp" %>
<%
//Log Footer end

%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
//sc.append("This is a ");
//sc.append("side column section.");

%>


<%@ include file="../globalfooter.jsp" %>
