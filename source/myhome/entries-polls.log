<%@ page import="reger.poll.PollUtil"%>
<%@ page import="java.util.ArrayList"%>
<%@ page import="java.util.Iterator"%>
<%@ page import="java.util.StringTokenizer"%>
<%@ page import="reger.poll.Poll"%>
<%@ page import="reger.cache.EntryCache"%>
<%@ page import="reger.Entry"%>
<%@ page import="reger.InfoBox"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
    reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
    pageProps.siteSection=pageProps.ADMINSITE;
    pageProps.title = "<img src='../images/poll-icon.gif' align=middle border=0> Polls";
    pageProps.isPasswordProtected = true;
    pageProps.navButtonName = "entriespolls";
    pageProps.aclObjectName = "ADDEDITENTRIES";
    pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
    pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/


    //Go get all polls for this account that this user can view
    ArrayList<Poll> polls = new ArrayList<Poll>();
    String sql = "SELECT poll.pollid FROM event, megalog, poll WHERE poll.eventid = event.eventid AND megalog.accountid='"+userSession.getAccount().getAccountid()+"' AND event.logid=megalog.logid AND " + userSession.getAccountuser().LogsUserCanAdministerQueryend(userSession.getAccount().getAccountid()) + " ORDER BY event.createdate DESC";
    //-----------------------------------
    //-----------------------------------
    String[][] rstData= reger.core.db.Db.RunSQL(sql);
    //-----------------------------------
    //-----------------------------------
    if (rstData!=null && rstData.length>0){
        for(int i=0; i<rstData.length; i++){
            polls.add(new Poll(Integer.parseInt(rstData[i][0])));
        }
    }


    //Display the list of polls

    mb.append(InfoBox.get(InfoBox.BOXTYPEINFO, pageProps.pathToAppRoot, "Create polls by editing entries.  Each poll must be tied to an entry."));

    mb.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));
    mb.append("<table cellpadding=0 cellspacing=0 border=0 width=90% >");

    for (java.util.Iterator it = polls.iterator(); it.hasNext(); ) {
        Poll poll = (Poll)it.next();
        Entry entry = EntryCache.get(poll.getEventid());

        mb.append("<tr><td>");
        String color = "ffffcc";
        if (!poll.getIsopen()){
            color = "ffffff";
        }
        if (poll.getNumberOfUnapprovedCommentsAndAnswers()>0){
            color="ffcc00";
        }
        mb.append(reger.ui.RoundedCorners.start("poll"+poll.getPollid(), color, "999999", 100));
        mb.append("<font face=arial size=+1><b>");
        mb.append( "<a href=entries-poll-settings.log?pollid="+poll.getPollid()+">"+poll.getQuestion()+"</a>");
        mb.append("</b></font>");
        mb.append("<font face=arial size=-2>");
        if (poll.getIsopen()) {
            mb.append("<br>Poll is Open for Voting");
        } else {
            mb.append("<br>Poll is Closed");
        }
        mb.append("</font>");
        mb.append("<font face=arial size=-2>");
        mb.append("<br>Total Votes : ");
        mb.append(poll.getTotalVotes());
        if (poll.getReaderscanaddcomments()){
            mb.append("<br>Total Comments : ");
            mb.append(poll.getNumberOfComments());
        }
        if (poll.getNumberOfUnapprovedCommentsAndAnswers()>0){
            mb.append("<br><img src='../images/yellow-alert.gif' border=0> Unapproved Answers/Comments : ");
            mb.append(poll.getNumberOfUnapprovedCommentsAndAnswers());
        }
        mb.append("<br>From Entry : ");
        mb.append("<a href=../entry.log?eventid=" + entry.eventid + ">"+entry.title+"</a>");
        mb.append("</font>");
        mb.append(reger.ui.RoundedCorners.end("poll"+poll.getPollid()));
        mb.append("</td></tr>");

    }

    mb.append("</table>");
    mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));
%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
%>

<%@ include file="../globalfooter.jsp" %>