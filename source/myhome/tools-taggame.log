<%@ page import="reger.core.db.Db,
                 reger.Media.MediaType,
                 reger.Media.MediaTypeFactory,
                 reger.core.db.Db"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.ADMINSITE;
pageProps.title = "Keyword Tag Game";
pageProps.isPasswordProtected = true;
pageProps.navButtonName = "toolstaggame";
pageProps.aclObjectName = "CUSTOMIZE";
pageProps.trafficType=reger.Vars.TRAFFICTYPEADMINMISC;
pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%

/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/








//Do the work
if (pageProps.action.equals("edittags")){
    if (request.getParameter("imagetag")!=null && request.getParameter("imageid")!=null && reger.core.Util.isinteger(request.getParameter("imageid"))){
        //-----------------------------------
        //-----------------------------------
        String[][] rstImg= Db.RunSQL("SELECT imageid FROM image, event, megalog WHERE image.imageid='"+request.getParameter("imageid")+"' AND image.eventid=event.eventid AND event.logid=megalog.logid AND " + userSession.getAccountuser().LogsUserCanViewQueryend(userSession.getAccount().getAccountid()));
        //-----------------------------------
        //-----------------------------------
        if (rstImg!=null && rstImg.length>0){
        	for(int i=0; i<rstImg.length; i++){
        	    reger.ImageTag.addMultipleTagsToImage(request.getParameter("imagetag"), Integer.parseInt(request.getParameter("imageid")));
        	}
        }
    }
}



//Helper text
mb.append("<font face=arial size=+1>");
mb.append("We'll admit, the Keyword Tag Game isn't much of a game... but it does help you tag your files which is very important for future retrieval.  The Keyword Tag Game displays a random file.  Your job is to edit or accept the keywords.  Simple.");
mb.append("</font>");
mb.append("<br>");
mb.append("<br>");

//Add the popup javascript
mb.append(reger.core.Util.popup());

mb.append(reger.ui.BubbleBox.start("", pageProps.pathToAppRoot));

mb.append("<form action=tools-taggame.log method=post>");

mb.append("<input type=hidden name='action' value='edittags'>");




mb.append("<table cellpadding=5 cellspacing=2 border=0>");

//reger.core.Util.logtodb("tools-tagwizard.log<br>" + reger.ImageListHtml.sqlBuilder(false, userSession, userSession.getAccount().getAccountid(), -1, -1, false, true)+sqlLimit);


mb.append("<tr>");
mb.append("<td valign=top align=left>");
mb.append("<input type=submit value='Continue'>");
mb.append("</td>");
mb.append("</tr>");



//Display the images
//-----------------------------------
//-----------------------------------
String[][] rstImagelist= Db.RunSQL(reger.ImageListHtml.sqlBuilder(false, userSession, userSession.getAccount().getAccountid(), -1, -1, false, false, true, ""));
//-----------------------------------
//-----------------------------------
if (rstImagelist!=null && rstImagelist.length>0){
    for(int i=0; i<rstImagelist.length; i++){

        mb.append("<input type=hidden name='imageid' value='"+rstImagelist[i][0]+"'>");

        mb.append("<tr>");
        mb.append("<td valign=top align=left>");
        mb.append("<font face=arial size=-2>");
        String tags = reger.ImageTag.getStringOfAllTagsForImage(Integer.parseInt(rstImagelist[i][0]));
        mb.append("<input type='text' name='imagetag' value=\""+reger.core.Util.cleanForSQL(tags)+"\" size=35 maxlength=254 style=\"font-size: 10px;\">");
        mb.append("</font>");
        mb.append("</td>");
        mb.append("</tr>");

        mb.append("<tr>");
        mb.append("<td valign=top align=left>");
        mb.append("<font face=arial size=-2>");
        mb.append(rstImagelist[i][1]);
        mb.append("</font>");
        mb.append("</td>");
        mb.append("</tr>");

        mb.append("<tr>");
        mb.append("<td valign=top align=left>");
        //Get the image file extension
        //String extension = reger.core.Util.getFilenameExtension(rstImagelist[i][9]);
        //MediaType mt = MediaTypeFactory.getHandlerByFileExtension(extension);
        //String tmp = mt.getMediaOutHtml(request, userSession);
        //if (mt instanceof reger.Media.UnknownFileType){
            //The file is of an unknown type so we're just going to redirect to the file directly so that the user can decide what to do with it.
            mb.append("<a href='"+pageProps.pathToAppRoot+"mediaouthtml.log?logid="+rstImagelist[i][8]+"&imageid="+rstImagelist[i][0]+"' onclick=\"javascript:NewWindow(this.href,'name','0','0','yes');return false;\">");
            mb.append("<img src='"+pageProps.pathToAppRoot+"mediaout.log?logid="+rstImagelist[i][8]+"&imageid="+rstImagelist[i][0]+"&isthumbnail=yes' border=0>");
            mb.append("</a>");
        //} else {
            //mb.append(tmp);
        //}
        mb.append("</td>");
        mb.append("</tr>");
    }
} else {
    mb.append("<tr>");
    mb.append("<td valign=top align=left>");
    mb.append("<font face=arial size=-2>");
    mb.append("There are no files so we can't play the Keyword Tag Game.");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("</tr>");
}

mb.append("</table>");

mb.append(reger.ui.BubbleBox.end(pageProps.pathToAppRoot));

mb.append("</form>");

mb.append("<br>");
mb.append("<br>");
mb.append("<br>");

%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
    StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

//sc.append("This is a ");
//sc.append("side column section.");
%>


<%@ include file="../globalfooter.jsp" %>
