<%@ page import="reger.core.ValidationException,
                 java.util.Calendar"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.MOBILEPRIVATE;
pageProps.isPasswordProtected = true;
pageProps.aclObjectName = "MOBILE";
pageProps.trafficType=reger.Vars.TRAFFICTYPEPUBLICHOMEPAGE;
pageProps.pathToAppRoot="../";
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/

String errortext = "";

if (pageProps.action.equals("add")){
    try {

		//Create an instance of the backend object
		reger.Entry entry = new reger.Entry();

		//Set the vars of the backend object
		entry.title=reger.core.Util.getParameterClean(request.getParameter("title"));
		entry.comments=reger.core.Util.getParameterClean(request.getParameter("comments"));

		entry.logid=pageProps.logProps.logid;
		entry.accountid=userSession.getAccount().getAccountid();
        entry.accountid=userSession.getAccountuser().getAccountuserid();
        entry.userSession = userSession;

		//Convert to usertime because mm, dd, etc. need to emulate user input
		Calendar apidate=reger.core.TimeUtils.gmttousertime(Calendar.getInstance(), userSession.getAccount().getTimezoneid());

        //Populate the date fields of the entry object
		entry.populateThisEventTimeVarsFromCal(apidate);

		//Make the actual entry
		entry.newEntryTemporary();
		try{
            entry.editEntryAll(entry.eventid);
            //Then redirect to the correct place
			//@todo On  successful mobile entry, show a success screen.
			response.sendRedirect("home.log");
			return;
        } catch (ValidationException error){
			//Show an error.
			errortext = errortext + "Entry Failed: " + error.getErrorsAsSingleString();
        }

    } catch (Exception e){
        reger.core.Util.errorsave(e);
    }
}


// set content type for wireless data
response.setContentType("text/vnd.wap.wml");

// write the data
mb.append("<?xml version=\"1.0\"?>");
mb.append("<!DOCTYPE wml PUBLIC \"-//WAPFORUM//DTD WML 1.1//EN\"");
mb.append(" \"http://www.wapforum.org/DTD/wml_1.1.xml\">");
mb.append("<wml>");


mb.append("<card id=\"login\" title=\"Add Entry\">");
mb.append("<p align=\"center\">");

if (!errortext.equals("")){
    mb.append(errortext);
    mb.append("<br/>");
}

mb.append("<br/>");
mb.append("Title: <input name=\"title\" type=\"text\" emptyok=\"false\"  value=\""+reger.core.Util.getParameterClean(request.getParameter("title"))+"\"/>");
mb.append("<br/>");
mb.append("Comments: <input name=\"comments\" type=\"text\" emptyok=\"false\" value=\""+reger.core.Util.getParameterClean(request.getParameter("comments"))+"\"/>");
mb.append("<a href=\"entry.log?title=$(title)&comments=$(comments)&logid="+pageProps.logProps.logid+"&action=add\">");
mb.append("Go");
mb.append("</a>");
mb.append("<br/>");
mb.append("<br/>");
mb.append("</p>");


mb.append("</card>");



mb.append("</wml>");

%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
%>

<%@ include file="../globalfooter.jsp" %>

