<%@ page import="reger.SideColumn, reger.core.db.Db"%>

<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.PUBLICSITE;
pageProps.isPasswordProtected = false;
pageProps.trafficType=reger.Vars.TRAFFICTYPEPUBLICMISC;
pageProps.pathToAppRoot="";
/*----------------------------------------------------*/
%>

<%@ include file="globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/





int emailsubscriberid=-1;
if (request.getParameter("emailsubscriberid")!=null && reger.core.Util.isinteger(request.getParameter("emailsubscriberid"))){
    emailsubscriberid=Integer.parseInt(request.getParameter("emailsubscriberid"));
}


if (pageProps.action.equals("addsubscriber") && request.getParameter("emailaddress")!=null && !request.getParameter("emailaddress").equals("")) {

	//Make sure this email isn't already in the system for this userid
	//-----------------------------------
	//-----------------------------------
	String[][] rstChkEml= Db.RunSQL("SELECT emailsubscriberid FROM emailsubscriber WHERE emailaddress='"+ reger.core.Util.cleanForSQL(request.getParameter("emailaddress")) +"' AND accountid='"+ userSession.getAccount().getAccountid() +"'");
	//-----------------------------------
	//-----------------------------------
	if (rstChkEml!=null && rstChkEml.length>0){
		//Already exists... no big deal... just pull up the prefs
		emailsubscriberid=Integer.parseInt(rstChkEml[0][0]);
	} else {
		//Doesn't exist... create the email subscription
		//-----------------------------------
		//-----------------------------------
		emailsubscriberid = Db.RunSQLInsert("INSERT INTO emailsubscriber(sendeveryxdays, emailaddress, accountid, htmlemail, lastsentdate) VALUES('7', '"+ reger.core.Util.cleanForSQL(request.getParameter("emailaddress")) +"', '"+ userSession.getAccount().getAccountid() +"', '1', DATE_ADD('"+reger.core.TimeUtils.nowInGmtString()+"',INTERVAL -7 DAY))");
		//-----------------------------------
		//-----------------------------------
    }

	response.sendRedirect("emailsubscription.log?emailsubscriberid=" + emailsubscriberid);
    return;
}



if (pageProps.action.equals("editsubscription")) {

    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("UPDATE emailsubscriber SET sendeveryxdays='"+ request.getParameter("sendeveryxdays") +"', emailaddress='"+ reger.core.Util.cleanForSQL(request.getParameter("emailaddress")) +"', htmlemail='"+ request.getParameter("htmlemail") +"' WHERE emailsubscriberid='"+ emailsubscriberid +"' AND accountid='"+ userSession.getAccount().getAccountid() +"'");
    //-----------------------------------
    //-----------------------------------

	response.sendRedirect("emailsubscription.log?emailsubscriberid=" + emailsubscriberid);
    return;
}

if (pageProps.action.equals("unsubscribe")) {
    //-----------------------------------
    //-----------------------------------
    int count = Db.RunSQLUpdate("DELETE FROM emailsubscriber WHERE emailaddress='"+ reger.core.Util.cleanForSQL(request.getParameter("emailaddress")) +"' AND accountid='"+ userSession.getAccount().getAccountid() +"' AND emailsubscriberid='"+ emailsubscriberid +"'");
    //-----------------------------------
    //-----------------------------------
}


int sendeveryxdays=7;
String emailaddress="";
int htmlemail=0;
String lastsentdate="";

//-----------------------------------
//-----------------------------------
String[][] rstGetSub= Db.RunSQL("SELECT sendeveryxdays, emailaddress, htmlemail, lastsentdate FROM emailsubscriber WHERE emailsubscriberid='"+ request.getParameter("emailsubscriberid") +"' AND accountid='"+ userSession.getAccount().getAccountid() +"'");
//-----------------------------------
//-----------------------------------
if (rstGetSub!=null && rstGetSub.length>0){
	sendeveryxdays=Integer.parseInt(rstGetSub[0][0]);
	emailaddress=rstGetSub[0][1];
	htmlemail=Integer.parseInt(rstGetSub[0][2]);
	lastsentdate=rstGetSub[0][3];

	mb.append("<font face=arial class=bigfont>");
	mb.append("Email Subscription Preferences");
	mb.append("</font>");
	mb.append("<br><br>");
	mb.append("<font face=arial class=mediumfont>");
	mb.append("<table cellpadding=0 cellspacing=5 border=0>");
	mb.append("<tr>");
	mb.append("<td valign=top align=right>Email Address:</td>");
	mb.append("<form action=emailsubscription.log method=post>");
	mb.append("<input type=hidden name=action value=editsubscription>");
	mb.append("<input type=hidden name=emailsubscriberid value="+ emailsubscriberid +">");
	mb.append("<td valign=top align=left><input type=text name=emailaddress value=\""+ reger.core.Util.cleanForHtml(emailaddress) +"\"></td>");
	mb.append("</tr>");
	mb.append("<tr>");
	mb.append("<td valign=top align=right>Send as HTML Email:</td>");
	mb.append("<td valign=top align=left>");
	mb.append("<input type='radio' name='htmlemail' value='1' ");
	if (htmlemail==1) {
		mb.append("checked");
    }
	mb.append("> Yes<br>");
	mb.append("<input type='radio' name='htmlemail' value='0' ");
	if (htmlemail==0) {
		mb.append("checked");
    }
	mb.append("> No<br>");
	mb.append("</td>");
	mb.append("</tr>");
	mb.append("<tr>");
	mb.append("<td valign=top align=right>Send Email Every:");
	mb.append("</td>");
	mb.append("<td valign=top align=left>");
	mb.append("<select name='sendeveryxdays'>");

	for(int i=1; i<=45; i++){
	    mb.append("<option value=" + i);
		if (i==sendeveryxdays) {
			mb.append(" selected");
        }
		mb.append(">"+ i +"</option>");
	}

	mb.append("</select> Days:</td>");
	mb.append("</tr>");
	mb.append("<tr>");
	mb.append("<td valign=top align=right>");
	mb.append("</td>");
	mb.append("<td valign=top align=left>");
	mb.append("<input type=submit value='Save Preferences'>");
	mb.append("</form>");
	mb.append("</td>");
	mb.append("</tr>");


	mb.append("<tr>");
	mb.append("<td valign=top align=right>");
	mb.append("Or, you can unsubscribe with one click:");
	mb.append("</td>");
	mb.append("<td valign=bottom align=left>");
	mb.append("<form action=emailsubscription.log method=post>");
	mb.append("<input type=hidden name=action value=unsubscribe>");
	mb.append("<input type=hidden name=emailsubscriberid value="+ emailsubscriberid +">");
	mb.append("<input type=hidden name=emailaddress value=\""+ reger.core.Util.cleanForHtml(emailaddress) +"\">");
	mb.append("<input type=submit value='Unsubscribe Me'>");
	mb.append("</form>");
	mb.append("</td>");
	mb.append("</tr>");

	mb.append("</table>");
	mb.append("</font>");
} else {
    if (request.getParameter("emailaddress")==null || request.getParameter("emailaddress").equals("")) {

		if (userSession.getAccount().isPro() && userSession.getAccount().getEmailnewsletter()==1) {
		    mb.append("<font face=arial class=bigfont>Please enter an email address.  Thanks.</.font><br><br>");
            mb.append(SideColumn.sideColTableStart("Email Subscription"));
            mb.append(SideColumn.sideColHeaderRow("Email Subscription"));
            mb.append(SideColumn.sideColContentRow("<form action=emailsubscription.log method=post><input type=hidden name=action value=addsubscriber><font face=arial class=smallfont size=-1>Enter your email address to receive this site via email.<br><input type=text name=emailaddress size=10 maxlength=49><br><input type='submit' value='Go'></font></form>"));
            mb.append(SideColumn.sideColTableEnd("Email Subscription"));
        }
    } else {
		mb.append("<font face=arial class=bigfont>The email subscription has been deleted.</.font><br><br>");
    }
}


%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/

%>

<%@ include file="globalfooter.jsp" %>

