<%@ page import="reger.logProps"%>
<%@ page import="reger.core.ErrorDissect" %>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.PUBLICSITE;
pageProps.isPasswordProtected = false;
pageProps.isLogidRequired=true;
pageProps.isEventidRequired=true;
pageProps.trafficType=reger.Vars.TRAFFICTYPEPUBLICENTRYDETAIL;
pageProps.pathToAppRoot="";
/*----------------------------------------------------*/
%>

<%@ include file="globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/

//Instantiate the entry object
//pageProps.entry.populate(userSession.getAccountuser(), userSession.getAccount(), userSession.getPl(), pageProps.logProps.logid, request);
int tmpEventid = 0;
if (request.getParameter("eventid")!=null && reger.core.Util.isinteger(request.getParameter("eventid"))) {
    tmpEventid=Integer.parseInt(request.getParameter("eventid"));
}
pageProps.entry = reger.cache.EntryCache.get(tmpEventid);
//pageProps.entry.getEntryAll(tmpEventid);

//Hide draft and unapproved entries
if (pageProps.entry.isDraft==1 || pageProps.entry.isApproved==0){
    Debug.debug(4, "entry.log", "redirecting to index because entry is draft or not approved");
    response.sendRedirect("index.log");
    return;
}

//Want to make sure the url displayed to the user is always the same so that url-based embed things work (Disqus)
try{
    //String entryurl="entry.log?logid=" + rsEvent[i][5] + "&eventid=" + rsEvent[i][4];
    //String entryurl="entry-logid" + rsEvent[i][5] + "-eventid" + rsEvent[i][4] + ".log";
    String entryurl = reger.Entry.entryFileNameStatic(pageProps.entry.logid, pageProps.entry.eventid, pageProps.entry.title);
    String entryurlComplete = "" + userSession.getAccount().getSiteRootUrl(userSession) + "/" + entryurl;
    Object originalRequestUriObj = request.getAttribute("javax.servlet.forward.request_uri");
    String originalRequestUri = "";
    if (originalRequestUriObj!=null && originalRequestUriObj instanceof String){
        originalRequestUri = (String)originalRequestUriObj;
    }
    //Add the servername and port
    //mb.append("<br/><br/>"+ErrorDissect.ServletUtilsdissect(request)+"<br/><br/>");
    //if (request.getLocalPort()!=80 && request.getLocalPort()!=443) {
    //    entryurlComplete = "" + userSession.getAccount().getSiteRootUrl(userSession) + ":" + request.getLocalPort() + "/" + entryurl;
    //}
    if (originalRequestUri!=null && !originalRequestUri.equals("") && originalRequestUri.indexOf(entryurl)<=-1 && request.getMethod().equalsIgnoreCase("GET")){
        Debug.debug(4, "entry.log", "originalRequestUri="+originalRequestUri);
        Debug.debug(4, "entry.log", "entryurl        ="+entryurl);
        Debug.debug(4, "entry.log", "entryurlComplete="+entryurlComplete);
        Debug.debug(4, "entry.log", "redrecting to "+entryurlComplete.trim());
        response.sendRedirect(entryurlComplete.trim());
        return;
    }
} catch (Exception ex){
    Debug.errorsave(ex, "entry.log unique url");
}

//Output javascript for disqus
    if (1==1){
        //Note that I'm using the version of the url without words on it for disqus
        String entryurl = reger.Entry.entryFileNameStaticNoWords(pageProps.entry.logid, pageProps.entry.eventid);
        String entryurlComplete = "" + userSession.getAccount().getSiteRootUrl(userSession) + "/" + entryurl;
        mb.append("\n\n<script type=\"text/javascript\">var disqus_url=\""+entryurlComplete+"\";</script>\n\n");
    }

//Start the page
//Determine which mode to display the page
boolean displayasadmin=false;

//Append the top of the form
mb.append(reger.MegaHtmlFormTop.getHtml(userSession, pageProps, displayasadmin, request, userSession.getAccount().getTimezoneid()));
//Append the center of the page
mb.append(reger.MegaHtmlFormCenter.getHtml(userSession, pageProps, displayasadmin, request));
//Append the bottom of the form
mb.append(reger.MegaHtmlFormBottom.getHtml(userSession, pageProps, displayasadmin, request, response));

%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/




%>

<%@ include file="globalfooter.jsp" %>

