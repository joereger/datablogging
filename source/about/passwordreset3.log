<%@ page import="reger.core.db.Db,
                 reger.Accountuser,
                 reger.core.db.Db"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.MARKETINGSITE;
pageProps.isPasswordProtected = false;
pageProps.trafficType=reger.Vars.TRAFFICTYPEMARKETINGSITEMISC;
pageProps.pathToAppRoot="../";
pageProps.marketingSiteSection = pageProps.MARKETINGSITESECTIONHOME;
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>



<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/


String errortext = "";
int accountuserid = -1;
String passphraseanswer = "";
String passphrasequestion = "";
String siterooturl = "";

//This page requires a valid username to continue
//-----------------------------------
//-----------------------------------
String[][] rstUser= Db.RunSQL("SELECT accountuserid, passphraseanswer, passphrasequestion FROM accountuser WHERE username='"+reger.core.Util.cleanForSQL(request.getParameter("username"))+"'");
//-----------------------------------
//-----------------------------------
if (rstUser!=null && rstUser.length>0){
    accountuserid = Integer.parseInt(rstUser[0][0]);
    passphraseanswer = rstUser[0][1];
    passphrasequestion = rstUser[0][2];
}  else {
    response.sendRedirect("passwordreset1.log?msg=usernamenotfound");
    return;
}




//Validate the passphrase answer
if (request.getParameter("passphraseanswer")!=null && !request.getParameter("passphraseanswer").equals("") && request.getParameter("passphraseanswer").equalsIgnoreCase(passphraseanswer)){

    //Try to Reset the password... it still has to pass verification
    Accountuser au = new Accountuser(accountuserid, true);
    siterooturl = au.getSiteRootUrlOfPrimaryAccount(userSession);
    au.setPassword(request.getParameter("password"));
    au.setVerifypassword(request.getParameter("verifypassword"));
    errortext = errortext + au.savePassword(request.getParameter("password"), request.getParameter("verifypassword"), userSession.getPl());

} else {

    errortext = errortext + "Passphrase answer incorrect.";

}



//Errortext
if (!errortext.equals("")){
    mb.append("<br><br>");
    mb.append("<blockquote>");
    mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
    mb.append("</blockquote>");
} else {


    response.sendRedirect(siterooturl + "/login.log?action=login&username="+java.net.URLEncoder.encode(request.getParameter("username"), "UTF-8")+"&password="+java.net.URLEncoder.encode(request.getParameter("password"), "UTF-8")+"&msg=passwordwasreset");
    return;

}

mb.append("<br><br><br>");




%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
%>


<%@ include file="../globalfooter.jsp" %>

