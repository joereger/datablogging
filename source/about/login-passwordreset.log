<%@ page import="reger.Accountuser"%>
<%@ page import="reger.core.PasswordHash"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.MARKETINGSITE;
pageProps.title = "Password Reset";
pageProps.navButtonName = "aboutindex";
pageProps.isPasswordProtected = false;
pageProps.trafficType=reger.Vars.TRAFFICTYPEMARKETINGSITEMISC;
pageProps.pathToAppRoot="../";
pageProps.marketingSiteSection = pageProps.MARKETINGSITESECTIONHOME;
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/

if (pageProps.action.equals("")){
    mb.append("<form action=login-passwordreset.log method=post>");
    mb.append("<input type=hidden name=action value=findbyemail>");
    mb.append("Find By Email: <input type=text name=email size=25 maxlength=100>");
    mb.append("<input type=submit value='Find'>");
    mb.append("</form>");
} else if (pageProps.action.equals("findbyemail")) {
    //-----------------------------------
    //-----------------------------------
    String[][] rstAu= reger.core.db.Db.RunSQL("SELECT accountuserid FROM accountuser WHERE email='"+reger.core.Util.cleanForSQL(request.getParameter("email"))+"'");
    //-----------------------------------
    //-----------------------------------
    if (rstAu!=null && rstAu.length>0){
        Accountuser au = new Accountuser(Integer.parseInt(rstAu[0][0]), true);
        boolean accountisreadyforactivation = true;
        if (au.getEmailactivationkey().equals("")){
            au.setEmailactivationkey(reger.core.RandomString.randomAlphanumeric(10));
            String errortext = au.saveSettings(userSession.getPl());
            if (!errortext.equals("")){
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
                accountisreadyforactivation = false;
            }
        }
        if (accountisreadyforactivation){
            reger.emailtext.BasicEmails.passwordResetMessage(au, au.getAccountid(), userSession.getPl(), "");
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "An email has been sent with a link that will allow you to change your password.  Please check your email."));
        }
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry, an account was not found.  Please click <a href='login-passwordreset.log'>here</a> to continue."));
    }
} else if (pageProps.action.equals("reset")) {
    String errortext="";
    if (request.getParameter("accountuserid")!=null && reger.core.Util.isinteger(request.getParameter("accountuserid")) && request.getParameter("key")!=null && !request.getParameter("key").equals("")){
        Accountuser au = new Accountuser(Integer.parseInt(request.getParameter("accountuserid")), true);
        if (au.getEmailactivationkey().equals(request.getParameter("key"))){
            au.setIsactivatedbyemail(true);
            errortext = au.saveSettings(userSession.getPl());
        } else {
            errortext = "Sorry, the activation key is not valid.  Please click <a href='login-passwordreset.log'>here</a> to continue.";
        }
        if (errortext.equals("")){
            mb.append("<form action=login-passwordreset.log method=post>");
            mb.append("<input type=hidden name=action value=resetupdatepassword>");
            mb.append("<input type=hidden name=accountuserid value="+au.getAccountuserid()+">");
            mb.append("New Password:<br><input type=password name=password value='' size=25 maxlength=100>");
            mb.append("<br>");
            mb.append("Retype New Password:<br><input type=password name=passwordverify value='' size=25 maxlength=100>");
            mb.append("<input type=submit value='Reset Password'>");
            mb.append("</form>");

        } else {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
        }
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry, the activation key is not valid.  Please click <a href='login-passwordreset.log'>here</a> to continue."));
    }
} else if (pageProps.action.equals("resetupdatepassword")) {
    if (request.getParameter("accountuserid")!=null && reger.core.Util.isinteger(request.getParameter("accountuserid"))){
        Accountuser au = new Accountuser(Integer.parseInt(request.getParameter("accountuserid")), true);
        String errortext = au.savePassword(request.getParameter("password"), request.getParameter("passwordverify"), userSession.getPl());
        if (errortext.equals("")){
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Success!  Your password has been changed.  Please click <a href='login.log'>here</a> to continue."));
        } else {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
        }
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry, the account user id was not set..  Please click <a href='login-passwordreset.log'>here</a> to continue."));
    }
}


%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
%>

<%@ include file="../globalfooter.jsp" %>

