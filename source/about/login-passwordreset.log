<%@ page import="reger.Accountuser"%>
<%@ page import="reger.core.PasswordHash"%>
<%@ page import="reger.core.EmailSendException"%>
<%
/*----------------------------------------------------*/
/*                  Page Config                       */
reger.pageFramework.PageProps pageProps = new reger.pageFramework.PageProps();
pageProps.siteSection=pageProps.MARKETINGSITE;
pageProps.title = "Password Reset";
pageProps.navButtonName = "aboutindex";
pageProps.isPasswordProtected = false;
pageProps.trafficType=reger.Vars.TRAFFICTYPEMARKETINGSITEMISC;
pageProps.pathToAppRoot="../";
pageProps.marketingSiteSection = pageProps.MARKETINGSITESECTIONHOME;
/*----------------------------------------------------*/
%>

<%@ include file="../globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/

if (pageProps.action.equals("")){
    mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEINFO, pageProps.pathToAppRoot, "Lost your password?  Not a problem."));

    mb.append("<br><br>");
    mb.append("<center>");
    mb.append("<font face=arial size=+1>");
    mb.append("Enter your email address.  We'll send you a link that will allow you to choose a new password.");
    mb.append("</font>");
    mb.append("</center>");
    mb.append("<br><br>");

    mb.append("<center>");
    mb.append("<form action=login-passwordreset.log method=post>");
    mb.append("<input type=hidden name=action value=findbyemail>");
    mb.append("<b>Email Address: </b><input type=text name=email size=25 maxlength=100>");
    mb.append("<br>");
    mb.append("<input type=submit value='Continue'>");
    mb.append("</form>");
    mb.append("</center>");
} else if (pageProps.action.equals("findbyemail")) {
    //-----------------------------------
    //-----------------------------------
    String[][] rstAu= reger.core.db.Db.RunSQL("SELECT accountuserid FROM accountuser WHERE email='"+reger.core.Util.cleanForSQL(request.getParameter("email"))+"'");
    //-----------------------------------
    //-----------------------------------
    if (rstAu!=null && rstAu.length>0){
        Accountuser au = new Accountuser(Integer.parseInt(rstAu[0][0]), true);
        boolean accountisreadyforactivation = true;
        if (au.getEmailactivationkey().equals("")){
            au.setEmailactivationkey(reger.core.RandomString.randomAlphanumeric(10));
            String errortext = au.saveSettings(userSession.getPl());
            if (!errortext.equals("")){
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
                accountisreadyforactivation = false;
            }
        }
        if (accountisreadyforactivation){
            try{
                reger.emailtext.BasicEmails.passwordResetMessage(au, au.getAccountid(), userSession.getPl(), "");
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "An email has been sent with a link that will allow you to change your password.  Please check your email."));
            } catch (EmailSendException ex){
                mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Oops!  There was an error sending the email:<br><br>"+ex.getErrorsAsSingleString()+"<br><br>Please click <a href='login-passwordreset.log'>here</a> to try again."));
            }

        }
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry, that email address was not found. Did you use another one to register?  Please click <a href='login-passwordreset.log'>here</a> to try again."));
    }
} else if (pageProps.action.equals("reset")) {
    String errortext="";
    if (request.getParameter("accountuserid")!=null && reger.core.Util.isinteger(request.getParameter("accountuserid")) && request.getParameter("key")!=null && !request.getParameter("key").equals("")){
        Accountuser au = new Accountuser(Integer.parseInt(request.getParameter("accountuserid")), true);
        if (au.getEmailactivationkey().equals(request.getParameter("key"))){
            au.setIsactivatedbyemail(true);
            errortext = au.saveSettings(userSession.getPl());
        } else {
            errortext = "Sorry, the activation key is not valid.  Please click <a href='login-passwordreset.log'>here</a> to continue.";
        }
        if (errortext.equals("")){
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEINFO, pageProps.pathToAppRoot, "Welcome back!  This page allows you to change your password."));
            mb.append("<br><br>");
            mb.append("<center>");
            mb.append("<font face=arial size=+1>");
            mb.append("Type the password that you'd like to use to log in with the email address "+au.getEmail()+".");
            mb.append("</font>");
            mb.append("</center>");
            mb.append("<br><br>");
            mb.append("<center>");
            mb.append("<form action=login-passwordreset.log method=post>");
            mb.append("<input type=hidden name=action value=resetupdatepassword>");
            mb.append("<input type=hidden name=accountuserid value="+au.getAccountuserid()+">");
            mb.append("<b>New Password: </b><input type=password name=password value='' size=25 maxlength=100>");
            mb.append("<br>");
            mb.append("<b>Retype New Password: </b><input type=password name=passwordverify value='' size=25 maxlength=100>");
            mb.append("<br>");
            mb.append("<input type=submit value='Save My New Password'>");
            mb.append("</form>");
            mb.append("</center>");

        } else {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
        }
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry, the activation key is not valid.  Please click <a href='login-passwordreset.log'>here</a> to continue."));
    }
} else if (pageProps.action.equals("resetupdatepassword")) {
    if (request.getParameter("accountuserid")!=null && reger.core.Util.isinteger(request.getParameter("accountuserid"))){
        Accountuser au = new Accountuser(Integer.parseInt(request.getParameter("accountuserid")), true);
        String errortext = au.savePassword(request.getParameter("password"), request.getParameter("passwordverify"), userSession.getPl());
        if (errortext.equals("")){
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPECOMPLETE, pageProps.pathToAppRoot, "Success!  The password for "+au.getEmail()+" has been changed.<br><br>Please click <a href='login.log'>here</a> to log in."));
        } else {
            mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, errortext));
        }
    } else {
        mb.append(reger.InfoBox.get(reger.InfoBox.BOXTYPEERROR, pageProps.pathToAppRoot, "Sorry, the account user id was not set..  Please click <a href='login-passwordreset.log'>here</a> to continue."));
    }
}


%>

<%
/*----------------------------------------------------*/
/*                  Side Column                       */
        StringBuffer sc = new StringBuffer();
/*----------------------------------------------------*/
%>

<%@ include file="../globalfooter.jsp" %>

